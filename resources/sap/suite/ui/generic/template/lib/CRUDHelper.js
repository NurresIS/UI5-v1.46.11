sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/ui/model/Context","sap/suite/ui/generic/template/lib/MessageUtils","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(q,B,C,M,F,a){"use strict";function c(d,E,b,m,s){b=b||"/"+E;return new Promise(function(g,h){if(d.getDraftContext().isDraftEnabled(E)){d.createNewDraftEntity(E,b).then(function(o){g(o.context);},function(o){h(o);});}else{s(true);return g(m.createEntry(b,{batchGroupId:"Changes",changeSetId:"Changes"}));}});}function r(m,b,t){var P=new Promise(function(d,g){m.read(b,{urlParameters:{"$expand":"DraftAdministrativeData"},success:function(o){d(o);},error:function(o){g(o);}});});t.oBusyHelper.setBusy(P,true);return P;}function R(t,E,k,s,m,T){var P=new Promise(function(b,d){var i,l,g,v,h=[];if(k&&s&&m){l=k.length;for(i=0;i<l;i++){g=k[i].PropertyPath;v=s[g][0];h.push(new F(g,a.EQ,v));}if(t.getDraftController().getDraftContext().isDraftEnabled(E)){var D=new F({filters:[new F("IsActiveEntity","EQ",false),new F("SiblingEntity/IsActiveEntity","EQ",null)],and:false});h.push(D);}var o=new F(h,true);m.read("/"+E,{urlParameters:{"$expand":"DraftAdministrativeData"},filters:[o],success:function(j){var n=f(j,m,s);if(n){b(n);}else{d(j);}},error:function(j){d(j);}});}});T.oBusyHelper.setBusy(P,true);return P;}function f(o,m,s){var b,i,l,d;if(o&&o.results){l=o.results.length;if(l==0){d=null;}else if(l==1){d=o.results[0];}else if(l>=1){var D=[];var A=[];for(i=0;i<l;i++){b=o.results[i];if(b&&b.IsActiveEntity){A.push(b);}else if(b&&b.IsActiveEntity==false){D.push(b);}}if(A.length==0&&D.length>=2){var g;for(var j=0;j<D.length;j++){g=D[j];if(g.DraftUUID==s.DraftUUID){d=g;break;}}if(!d){d=D[0];}}else if(A.length==1&&D.length==1){d=A[0];}else if(A.length==1&&D.length>=2){d=A[0];}}}return d;}function p(P,o,t,A){if(!A.getModel().getMetaModel().getODataEntitySet(o.getPath().split("(")[0].substring(1))){return Promise.resolve();}var b=A.getApplicationController();if(!b.getTransactionController().getDraftController().getDraftContext().hasDraft(o)){return Promise.resolve();}return b.propertyChanged(P,o).catch(function(E){t.oApplicationProxy.getResourceBundleForEditPromise().then(function(d){var n=A.getNavigationController();var m=A.getModel();M.handleError(M.operations.modifyEntity,null,null,E,{resourceBundle:d,navigationController:n,model:m});M.handleTransientMessages(t.oApplicationProxy.getDialogFragment);});});}function u(t,d,b){return new Promise(function(g,h){var U=t.oApplicationProxy.getDialogFragment("sap.suite.ui.generic.template.ObjectPage.view.fragments.UnsavedChangesDialog",{onEdit:function(){U.close();g();},onCancel:function(){U.close();h();}},"Dialog");var s=t.getText("DRAFT_LOCK_EXPIRED",[d.LastChangedByUserDescription||d.LastChangedByUser]);U.getModel("Dialog").setProperty("/unsavedChangesQuestion",s);(b||q.noop)();t.oBusyHelper.getUnbusy().then(function(){U.open();});});}function e(t,E,b,m,T,d,k,s){if(b===""&&k&&s){return new Promise(function(g,h){R(t,E,k,s,m,T).then(function(i){var j="/"+m.createKey(E,i);var o=new C(m,j);if(!i.DraftAdministrativeData||i.DraftAdministrativeData.DraftIsCreatedByMe){g(t.editEntity(o,false));}else if(i.DraftAdministrativeData.InProcessByUser){h({lockedByUser:i.DraftAdministrativeData.InProcessByUserDescription||i.DraftAdministrativeData.InProcessByUser});}else{u(T,i.DraftAdministrativeData,d).then(function(){g(t.editEntity(o,false));},function(){h({lockedByUser:i.DraftAdministrativeData.LastChangedByUserDescription||i.DraftAdministrativeData.LastChangedByUser});});}},function(i){h({draftAdminReadResponse:i});});});}var D=t.getDraftController().getDraftContext();var o=new C(m,b);if(D.isDraftEnabled(E)){if(true||!D.hasPreserveChanges(o)){return new Promise(function(g,h){r(m,b,T).then(function(i){if(!i.DraftAdministrativeData||i.DraftAdministrativeData.DraftIsCreatedByMe){g(t.editEntity(o,false));}else if(i.DraftAdministrativeData.InProcessByUser){h({lockedByUser:i.DraftAdministrativeData.InProcessByUserDescription||i.DraftAdministrativeData.InProcessByUser});}else{u(T,i.DraftAdministrativeData,d).then(function(){g(t.editEntity(o,false));},function(){h({lockedByUser:i.DraftAdministrativeData.LastChangedByUserDescription||i.DraftAdministrativeData.LastChangedByUser});});}},function(i){h({draftAdminReadResponse:i});});});}}else{T.oApplicationProxy.setEditableNDC(true);return Promise.resolve({context:o});}}return{create:c,edit:e,propertyChange:p};});
