sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/m/MessageToast","sap/ui/generic/app/util/ModelUtil","sap/ui/generic/app/util/ActionUtil","sap/suite/ui/generic/template/lib/MessageUtils","sap/m/MessageBox","sap/suite/ui/generic/template/lib/CRUDHelper","sap/suite/ui/generic/template/lib/testableHelper","sap/m/Table","sap/ui/table/AnalyticalTable"],function(q,B,M,a,A,b,c,C,t,T,d){"use strict";var r=Promise.reject();r.catch(q.noop);function g(o,e,s,f,h){function k(O,i,j,P){b.handleError(O,o,s,j,P);return(i||q.noop)(j);}function l(){b.handleTransientMessages(s.oApplication.getDialogFragmentForView.bind(null,null));}var E;function m(i){return new Promise(function(j,J){var K=o.getOwnerComponent();var L=K.getBindingContext();var N=K.getModel();N.read(L.getPath(),{urlParameters:{"$expand":"DraftAdministrativeData"},success:function(R){if(!R.DraftAdministrativeData){if(i){return k(b.operations.editEntity,J,i);}return j({});}if(R.DraftAdministrativeData.InProcessByUser){var U=R.DraftAdministrativeData.InProcessByUserDescription||R.DraftAdministrativeData.InProcessByUser;i=i||new Error(f.getText("ST_GENERIC_DRAFT_LOCKED_BY_USER",[" ",U]));return k(b.operations.editEntity,J,i,i);}return j({draftAdministrativeData:R.DraftAdministrativeData});},error:k.bind(null,b.operations.editEntity,J)});});}function n(i,U,P){if(P.draftAdministrativeData){return Promise.resolve(P);}return new Promise(function(j,J){s.oTransactionController.editEntity(o.getView().getBindingContext(),!U).then(function(R){l(R);return j({context:R.context});},function(R){if(R&&R.response&&R.response.statusCode==="409"&&i&&!U){b.removeTransientMessages();return m(R).then(j,J);}else{k(b.operations.editEntity,J,R,R);}});});}E=function(U){var i=f.isDraftEnabled();var R;var j=o.getOwnerComponent();var J=j.getBindingContext();if(i&&!U){var K=s.oDraftController.getDraftContext();var P=K.hasPreserveChanges(J);if(!P){R=m().then(n.bind(null,true,true));}}R=R||n(i,U,{});if(i){s.oApplication.editingStarted(J,R);}return R;};function p(U){if(h.isBusy()){return r;}var R=E(U);h.setBusy(R);return R;}function u(i,j,J,K,N){var R=new Promise(function(L,O){var P=function(Q){o.getOwnerComponent().getComponentContainer().bindElement(J.getPath());return k(b.operations.deleteEntity,O,Q);};if(i&&K){s.oDraftController.getDraftForActiveEntity(J).then(function(Q){s.oTransactionController.deleteEntity(Q.context).then(function(){if(!N){s.oApplication.showMessageToast(f.getText("ST_GENERIC_DRAFT_WITH_ACTIVE_DOCUMENT_DELETED"));}return L();});},P);}else{s.oTransactionController.deleteEntity(J).then(function(){var Q=a.getEntitySetFromContext(J);var S=s.oDraftController.getDraftContext();var U=S.isDraftRoot(Q);var V=f.getText("ST_GENERIC_OBJECT_DELETED");if(!i&&U){V=f.getText(j?"ST_GENERIC_DRAFT_WITH_ACTIVE_DOCUMENT_DELETED":"ST_GENERIC_DRAFT_WITHOUT_ACTIVE_DOCUMENT_DELETED");}if(!N){s.oApplication.showMessageToast(V);}return L();},P);}});return R;}function v(i,N,R,j){if(h.isBusy()){j();return;}var J=o.getView().getBindingContext();var K=s.oDraftController.isActiveEntity(J);var L=s.oDraftController.hasActiveEntity(J);var S;if(i){S=Promise.resolve(J);}else if(L&&!K){S=s.oApplication.getDraftSiblingPromise(J);}else{S=Promise.resolve();}S.then(function(O){var P=u(K,L,J,i,N);P.then(R,j);if(L&&!K){var Q=function(){return{context:O};};var U=P.then(Q);s.oApplication.cancellationStarted(J,U);}},j);}function w(i,N){var R=new Promise(function(j,J){s.oApplication.performAfterSideEffectExecution(v.bind(null,i,N,j,J));});h.setBusy(R);return R;}function x(P){var R=new Promise(function(J,K){s.oTransactionController.deleteEntities(P).then(function(L){var N=[];var O=sap.ui.getCore().getMessageManager().getMessageModel().getData();for(var i=0;i<O.length;i++){var Q=O[i].getTarget();for(var j=0;j<P.length;j++){if(Q.indexOf(P[j])>-1){N.push(Q);break;}}}return J(N);},function(i){return K(i);});});R.then(function(j){var J=[];for(var i=0;i<P.length;i++){if(j.indexOf(P[i])===-1){J.push(P[i]);}}s.oApplication.adaptAfterDeletion(J,e.getViewLevel());});return R;}function y(i,j){if(h.isBusy()){j();return;}s.oTransactionController.triggerSubmitChanges().then(function(R){l();i(R.context);},k.bind(null,b.operations.saveEntity,j));}function z(){var R=new Promise(function(i,j){s.oApplication.performAfterSideEffectExecution(y.bind(null,i,j));});h.setBusy(R);return R;}function D(){if(h.isBusy()){return r;}var R=new Promise(function(i,j){var J=o.getView().getBindingContext();var K=s.oDraftController.activateDraftEntity(J);s.oApplication.activationStarted(J,K);K.then(function(L){var P=L.context.getPath();function N(){l();i(L);}var O=e.getPreprocessorsData().rootContextExpand;if(O){var Q=O.join(",");o.getView().getModel().read(P,{urlParameters:{"$select":Q,"$expand":Q},success:N,error:N});}else{N();}},k.bind(null,b.operations.activateDraftEntity,j));});h.setBusy(R);return R;}function F(P){return new A(P);}function G(P,S,R,j){if(h.isBusy()){j();return;}var J=P.functionImportPath;var K=P.contexts;var L=P.sourceControl;var N=P.label;var O=P.navigationProperty;var Q=P.operationGrouping;var U=F({controller:o,contexts:K,applicationController:s.oApplicationController,operationGrouping:Q});var V=function(Z,$){if(Z.pages){for(var i in Z.pages){var _=Z.pages[i];if(_.component.list!=true&&_.entitySet===$){return true;}else{var a1=V(_,$);if(a1){return true;}}}}return false;};var W=function(i,Z){var $=i.getAppComponent().getConfig();if(Z&&Z.sPath){var _=Z.sPath.split("(")[0].replace("/","");return V($.pages[0],_);}return false;};var X=function(i){var Z,$,_,a1;if(q.isArray(i)&&i.length===1){Z=i[0];}else{Z={response:{context:i.context}};}$=Z.response&&Z.response.context;_=o.getOwnerComponent();a1=W(_,$);if(a1&&$&&$!==Z.actionContext&&$.getPath()!=="/undefined"){if(L){f.navigateFromListItem($,L);}else{s.oNavigationController.navigateToContext($,O,false);}}if(i.length>0){var b1=f.getTableBindingInfo(L);var c1=b1&&b1.binding;if(c1&&c1.oEntityType){f.setEnabledToolbarButtons(L);var d1=_.getComponentContainer();var e1=d1&&d1.getSettings();var f1=e1&&e1.routeConfig;if(f1){if(sap.suite.ui.generic.template.js.AnnotationHelper.isListReportTemplate(f1)){f.setEnabledFooterButtons(L,o);}}}}R(i);};var Y=function(i){if(q.isArray(i)){if(i.length===1){i=i[0].error;}else{i=null;}}var Z={context:K};if(K&&K[0]){var $=K[0].oModel;if($&&$.hasPendingChanges()){$.resetChanges();}}k(b.operations.callAction,null,i,Z);j(i);};U.call(J,N).then(function(i){if(i&&i.executionPromise){h.setBusy(i.executionPromise);i.executionPromise.then(X,Y);}else{if(!i){j();}else{X(i);}}},function(i){if(!i){j();}else{Y(i);}});}function H(P,S){var R=new Promise(function(i,j){s.oApplication.performAfterSideEffectExecution(G.bind(null,P,S,i,j));});return R;}function I(i){if(!i){throw new Error("Unknown Table");}var j="";var J="";var K=o.getOwnerComponent().getEntitySet();var L,N,O,P;var V=o.getView();var Q=V.getModel();var R=V.getBindingContext();if(R){J=f.getTableBindingInfo(i).path;P=Q.getMetaModel();N=P.getODataEntitySet(K);L=P.getODataEntityType(N.entityType);O=P.getODataAssociationSetEnd(L,J);if(O){K=O.entitySet;}J="/"+J;j=R.getPath()+J;}else{j="/"+K;}var S=C.create(s.oDraftController,K,j,Q,s.oApplication.setEditableNDC);s.oApplication.getBusyHelper().setBusy(S);return S.then(function(U){return{newContext:U,tableBindingPath:J};},k.bind(null,b.operations.addEntry,function(U){throw U;}));}var k=t.testable(k,"handleError");var F=t.testable(F,"getActionUtil");return{editEntity:p,deleteEntity:w,deleteEntities:x,saveEntity:z,activateDraftEntity:D,callAction:H,addEntry:I};}return B.extend("sap.suite.ui.generic.template.lib.CRUDManager.js",{constructor:function(o,e,s,f,h){q.extend(this,g(o,e,s,f,h));}});});
