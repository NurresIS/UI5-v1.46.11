sap.ui.define(["sap/f/FlexibleColumnLayout","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/generic/app/util/ModelUtil","sap/suite/ui/generic/template/lib/CRUDHelper","sap/suite/ui/generic/template/lib/FlexibleColumnLayoutHandler","sap/suite/ui/generic/template/lib/testableHelper","sap/m/routing/Targets"],function(F,a,b,M,C,c,t,T){"use strict";function d(i,j,V,w,x){var y={};y={viewName:V,controlId:j,controlAggregation:x};var z=i.getTargets();z.addTarget(w,y);}function e(N,i){if(N.oTemplateContract.oFlexibleColumnLayoutHandler){N.oTemplateContract.oFlexibleColumnLayoutHandler.createMessagePageTargets(d.bind(null,N.oRouter,i,"sap.suite.ui.generic.template.fragments.MessagePage"));}else{d(N.oRouter,i,"sap.suite.ui.generic.template.fragments.MessagePage","messagePage","pages");}}function g(N){var i=N.oTemplateContract.oNavigationHost.getId();var j=N.oAppComponent.getConfig(),w,x;if(!j.pages||!j.pages.length){throw new Error("Route Configuration missing");}if(j.pages.length>1){throw new Error("Currently only one Top route supported");}w=j.pages[0];N.oTemplateContract.mEntityTree={};x=l([],w,"root",0,null,N,i);N.oRouter.addRoute(x);k(x,N);f(x.target,w,0,null,N,i);e(N,i);return w.entitySet;}function f(j,w,L,x,N,y,z){var i,A;if(w.pages){A=w.pages.length;for(i=0;i<A;i++){h(j,w.pages[i],(L+1),x,N,y,z);}}}function h(i,j,L,w,N,x,y){if(j.component){var z={parent:w&&w.entitySet,navigationProperty:j.navigationProperty,level:L,children:[]};var A=l(i,j,j.component.list?"aggregation":"detail",L,w,N,x);z.sRouteName=A.name;z.entitySet=A.entitySet;if(y){y.push(A.entitySet);}var E=N.oTemplateContract.mEntityTree[A.entitySet];if(!E||E.level>z.level){N.oTemplateContract.mEntityTree[A.entitySet]=z;}N.oRouter.addRoute(A);k(A,N);f(A.target,j,L,A,N,x,z.children);}}function k(i,N){var Q=jQuery.extend({},i);Q.name=i.name+"query";Q.pattern=i.pattern+"{?query}";N.oRouter.addRoute(Q);}function l(i,j,O,L,w,N,x){var y=jQuery.isArray(i)?i:[i];var z,A;z=j.navigationProperty||j.entitySet;A=jQuery.extend({},j);A.path="/"+j.entitySet;A.operation=O;A.viewLevel=L;A.template=j.component?(j.component.name||j.component):j.template;switch(O){case"root":A.name="root";A.pattern="";break;case"aggregation":A.name=z+"~aggregation";A.pattern=z;break;default:A.name=z;A.pattern=z+"({keys"+L+"})";break;}if(w){A.name=w.name+"/"+A.name;A.pattern=w.pattern+"/"+A.pattern;A.parentEntitySet=w.entitySet;}if(A.viewLevel===1){N.oTemplateContract.routeViewLevel1={pattern:A.pattern,name:A.name};}var B;var E=A.name;if(N.oTemplateContract.oFlexibleColumnLayoutHandler){B=N.oTemplateContract.oFlexibleColumnLayoutHandler.adaptRoutingInfo(A,E,y);}else{B="pages";A.target=E;}d(N.oRouter,x,A.name,E,B);var G=new Promise(function(H){N.mRouteToComponentResolve[A.name]=H;});N.oTemplateContract.mRouteToTemplateComponentPromise[A.name]=G;return A;}function I(N,S){var H;if(!N.oHashChanger.getHash()){H="";if(S&&S.route&&S.route.length===1){H=S.route[0];N.navigate(H,true);}}N.oRouter.initialize();N.fnInitializationResolve();}function r(N,E,K,S,j){var i,L,w,V,x=[];if(K&&S&&j){L=K.length;for(i=0;i<L;i++){w=K[i].PropertyPath;V=S[w][0];x.push(new a(w,b.EQ,V));}if(N.oAppComponent.getTransactionController().getDraftController().getDraftContext().isDraftEnabled(E)){var y=new a({filters:[new a("IsActiveEntity","EQ",false),new a("SiblingEntity/IsActiveEntity","EQ",null)],and:false});x.push(y);}var z=new a(x,true);j.read("/"+E,{filters:[z],success:function(A){var B=R(A,j,S);if(B){var G=j.getKey(B);if(G){N.navigate(G,true);}}I(N,S);},error:function(A){I(N,S);}});}}function R(w,x,S){var y,i,L,z;if(w&&w.results){L=w.results.length;if(L==0){z=null;}else if(L==1){z=w.results[0];}else if(L>=1){var A=[];var B=[];for(i=0;i<L;i++){y=w.results[i];if(y&&y.IsActiveEntity){B.push(y);}else if(y&&y.IsActiveEntity==false){A.push(y);}}if(B.length==0&&A.length>=2){var E;for(var j=0;j<A.length;j++){E=A[j];if(E.DraftUUID==S.DraftUUID){z=E;break;}}if(!z){z=A[0];}}else if(B.length==1&&A.length==1){z=B[0];}else if(B.length==1&&A.length>=2){z=B[0];}}}return z;}function m(i,j){if((i&&j)||(j==="display")){return{mode:"unsupported"};}var w={mode:"display",force:"false"};w.mode=j||i||w.mode;w.force=!!j;return w;}function D(j,N,E,S,w){var x=o(j,N,E,S,w);var H;if(x.bNavigationWithSemanticKeyPossible){r(N,E,x.aSemanticKey,S,j);return;}else if(x.bNavigationWithTechnicalKeyPossible){if(S.IsActiveEntity&&S.IsActiveEntity[0]==="false"&&S.DraftUUID&&S.DraftUUID[0]!==""){var K=[];for(var i=0;i<x.aTechnicalKey.length;i++){var y=x.aTechnicalKey[i]&&x.aTechnicalKey[i].name;if(y==="DraftUUID"||y==="IsActiveEntity"){continue;}if(S.hasOwnProperty(y)){K.push({PropertyPath:y});}}r(N,E,K,S,j);return;}H=j.createKey(E,S);if(H){N.navigate(H,true);}}I(N,S);}function n(K,j){var i,L,S=false,w,x;if(j&&K){L=K.length;for(i=0;i<L;i++){S=true;w=K[i];x=w.name||w.PropertyPath;if(!j[x]||j[x].length>1){S=false;break;}}}return S;}function o(i,N,E,S,j){var w={};if(!N.oRouter.getRoute(E)){return{};}if(N.oAppComponent.getManifestEntry("sap.ui.generic.app").pages[0].pages[0].navigation&&N.oAppComponent.getManifestEntry("sap.ui.generic.app").pages[0].pages[0].navigation[j.mode]){return{};}var x=i.getMetaModel().getODataEntitySet(E);if(!x){return{};}var y=i.getMetaModel().getODataEntityType(x.entityType);var z=y["com.sap.vocabularies.Common.v1.SemanticKey"];if(z){w={bNavigationWithSemanticKeyPossible:n(z,S),aSemanticKey:z};}if(y.key.propertyRef){w.bNavigationWithTechnicalKeyPossible=n(y.key.propertyRef,S);w.aTechnicalKey=y.key.propertyRef;}return w;}function p(N){var G=N.oAppComponent.getModel("_templPrivGlobal");G.setProperty("/generic/forceFullscreenCreate",true);}function P(N,E,S){var j;j=N.oAppComponent.getModel();j.attachMetadataFailed(N.fnInitializationResolve);j.getMetaModel().loaded().then(function(){var w;var x=S.preferredMode&&S.preferredMode[0];var y=S.mode&&S.mode[0];var z=m(x,y);if(S.DraftUUID){var A=S.DraftUUID[0];if(A&&A.indexOf("guid")!==-1){A=A.replace("guid","");A=A.replace("'","");A=A.replace("'","");S.DraftUUID[0]=A;}}switch(z.mode){case"create":p(N);var B=C.create(N.oAppComponent.getTransactionController().getDraftController(),E,"/"+E,j,N.oTemplateContract.oApplicationProxy.setEditableNDC);B.then(function(O){N.navigateToContext(O,"",true,4).then(I.bind(null,N,S));},function(O){I(N,S);N.navigateToMessagePage({title:N.oTemplateContract.getText("ST_GENERIC_ERROR_TITLE"),text:O.messageText,description:"",icon:"sap-icon://message-error",replaceURL:true});});N.oTemplateContract.oBusyHelper.setBusy(B,true);break;case"createWithContext":p(N);w=j.getMetaModel().getODataEntitySet(E);var G=w["com.sap.vocabularies.Common.v1.DraftRoot"];if(G&&G.NewAction){var H=j.getMetaModel().getODataFunctionImport(G.NewAction.String.split("/")[1]);var U={};if(H&&H.parameter){for(var i=0;i<H.parameter.length;i++){if(H.parameter[i].mode==="In"&&S[H.parameter[i].name][0]){U[H.parameter[i].name]=S[H.parameter[i].name][0];}}sap.ui.core.BusyIndicator.show();j.callFunction("/"+H.name,{success:function(O,Q){I(N,S);sap.ui.core.BusyIndicator.hide();var V=new M(j);var W=V.getContextFromResponse(O);if(W){N.navigateToContext(W,null,true,4).then(I.bind(null,N,S));}else{I(N,S);N.navigateToMessagePage({title:N.oTemplateContract.getText("ST_GENERIC_UNKNOWN_NAVIGATION_TARGET"),replaceURL:true});}},error:function(O){sap.ui.core.BusyIndicator.hide();N.navigateToMessagePage({title:N.oTemplateContract.getText("ST_GENERIC_UNKNOWN_NAVIGATION_TARGET"),replaceURL:true});},method:"POST",urlParameters:U});}else{N.navigateToMessagePage({title:N.oTemplateContract.getText("ST_GENERIC_UNKNOWN_NAVIGATION_TARGET"),replaceURL:true});}}break;case"edit":var J=o(j,N,E,S,z);if(J.bNavigationWithTechnicalKeyPossible||J.bNavigationWithSemanticKeyPossible){var K="";var L;if(J.bNavigationWithTechnicalKeyPossible){K=j.createKey(E,S);L=C.edit(N.oAppComponent.getTransactionController(),E,"/"+K,j,N.oTemplateContract,N.fnInitializationResolve);}else if(J.bNavigationWithSemanticKeyPossible){K="";L=C.edit(N.oAppComponent.getTransactionController(),E,K,j,N.oTemplateContract,N.fnInitializationResolve,J.aSemanticKey,S);}L.then(function(O){N.navigate(O.context.getPath(),true);I(N);},function(O){if(O.lockedByUser){if(!z.force){D(j,N,E,S,z);}else{N.fnInitializationResolve();N.navigateToMessagePage({title:N.oTemplateContract.getText("LOCKED_OBJECT_POPOVER_TITLE"),text:N.oTemplateContract.getText("LOCKED_OBJECT_POPOVER_TITLE"),description:N.oTemplateContract.getText("ST_GENERIC_LOCKED_OBJECT_POPOVER_TEXT",[O.lockedByUser]),icon:"sap-icon://message-error",replaceURL:true});}}else if(O.draftAdminReadResponse){I(N,S);}});}else{I(N,S);}break;case"display":D(j,N,E,S,z);break;default:N.fnInitializationResolve();N.navigateToMessagePage({title:N.oTemplateContract.getText("ST_GENERIC_ERROR_TITLE"),text:N.oTemplateContract.getText("ST_GENERIC_ERROR_TITLE"),description:N.oTemplateContract.getText("PARAMETER_COMBINATION_NOT_SUPPORTED",[y,x]),icon:"sap-icon://message-error",replaceURL:true});}});}function s(N){var i=N.oAppComponent.getManifestEntry("sap.ui.generic.app");if(i.settings&&i.settings.flexibleColumnLayout){N.oTemplateContract.oFlexibleColumnLayoutHandler=new c(N.oTemplateContract.oNavigationHost,N);}var E=g(N);var j=N.oAppComponent.getComponentData();var S=j&&j.startupParameters;if(E&&S&&!N.oHashChanger.getHash()){P(N,E,S);}else{I(N);}}function q(i){var j,w,x;if(i){j=i.pattern;w=i.navigationProperty||i.entitySet;if(j&&w){x=j.indexOf("{?query}");if(x>0){j=j.substring(0,x);}x=-1;w+="({keys";x=j.indexOf(w);if(x>0){j=j.substring(x);}if(i.navigationProperty){j=j.replace(i.navigationProperty,i.entitySet);}j="/"+j;}}return j;}function u(i,E,j){var w,K,x;if(i.operation==="root"){return null;}if(i.operation==="aggregation"){w=i.pattern;}else{if(j){w=j;}else{w=q(i);}}if(w.indexOf("/")!==0){w="/"+w;}K=E.getParameter("arguments");if(K){for(x in K){if(x!=="?query"){w=w.replace("{"+x+"}",K[x]);}}return w;}}function v(i,N){var j,w,E;j=i.getPath().substring(1);w=j.split("(");if(w[0]){E=w[0];}if(N){j=j.replace(E,N);if(j.indexOf("/")===0){j=j.substring(1);}}return{entitySet:E,path:j};}var g=t.testableStatic(g,"routingHelpergenerateRoutingMetadataAndGetRootEntitySet");var I=t.testableStatic(I,"routingHelper_initialiseRouting");var r=t.testableStatic(r,"routingHelper_readObject");var P=t.testableStatic(P,"routingHelper_processStartupParameters");return{startupRouter:s,determinePath:u,determineNavigationPath:v,readObjectProcessResults:R};});
