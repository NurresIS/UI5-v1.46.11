sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/ui/model/json/JSONModel","sap/m/ObjectIdentifier","sap/m/Table","sap/m/Text","sap/ui/comp/smartfield/SmartField","sap/ui/generic/app/navigation/service/SelectionVariant","sap/suite/ui/generic/template/ListReport/extensionAPI/ExtensionAPI","sap/m/MessageBox","sap/suite/ui/generic/template/js/AnnotationHelper","sap/suite/ui/generic/template/lib/MessageUtils","sap/suite/ui/generic/template/ListReport/controller/IappStateHandler","sap/ui/table/Table","sap/ui/table/AnalyticalTable","sap/ui/model/Filter"],function(q,B,J,O,T,a,S,b,E,M,A,c,I,U,d,F){"use strict";return{getMethods:function(v,t,C){var s={};var o;var e=true;function f(){var i=C.getOwnerComponent();var m=i.getModel("_templPriv");m.setProperty("/listReport/isLeaf",i.getIsLeaf());}function g(){var G=q.sap.getObject("sap.ushell.Container.getUser");var m=C.getOwnerComponent().getAppComponent().getMetadata().getManifestEntry("sap.ui");var i=(m&&m.icons&&m.icons.icon)||"";var n={bookmarkIcon:i,bookmarkCustomUrl:function(){var H=hasher.getHash();return H?("#"+H):window.location.href;},bookmarkServiceUrl:function(){var u=s.oSmartTable.getTable();var w=u.getBinding("rows")||u.getBinding("items");return w?w.getDownloadUrl()+"&$top=0&$inlinecount=allpages":"";},isShareInJamActive:!!G&&G().isJamActive()};var r=C.getOwnerComponent().getModel("_templPriv");r.setProperty("/listReport/share",n);}function h(i){C.onInitSmartFilterBarExtension(i);o.onSmartFilterBarInitialise();}function j(){var i=o.parseUrlAndApplyAppState();i.then(function(){e=false;},function(m){if(m instanceof Error){m.showMessageBox();e=false;}});}function k(){if(!e){o.changeIappState(true,false);}}function p(){var m=C.getOwnerComponent().getAppComponent().getMetadata().getManifestEntry("sap.ui.generic.app");if(m&&m.pages[0]&&m.pages[0].component&&m.pages[0].component.settings&&m.pages[0].component.settings.tableTabs){var n;s.aSmartTables=[];for(var i in m.pages[0].component.settings.tableTabs){var K=m.pages[0].component.settings.tableTabs[i].key;n=C.byId("listReport-"+K);s.aSmartTables.push(n);}s.oSmartTable=s.aSmartTables[0];for(i=1;i<s.aSmartTables.length;i++){s.aSmartTables[i].setVisible(false);}s.oSmartFilterbar.attachSearch(function(r){s.oSmartTable._reBindTable(r);});}}function l(i){var m,n,r,D,u;m=i.getParameters().mainNavigation;u=i.getSource();n=u.getText&&u.getText();r=t.oCommonUtils.getCustomData(i);D=r["LinkDescr"];m.setDescription(D);i.getParameters().show(n,m,undefined,undefined);}return{onInit:function(){s.oSmartFilterbar=C.byId("listReportFilter");s.oSmartTable=C.byId("listReport");p();o=new I(s,C,t.oCommonUtils.getNavigationHandler());t.oServices.oApplication.registerStateChanger({isStateChange:o.isStateChange});v.getUrlParameterInfo=o.getUrlParameterInfo;v.onComponentActivate=function(){if(!e){o.parseUrlAndApplyAppState();}};v.refreshBinding=function(){if(o.areDataShownInTable()){t.oCommonUtils.refreshSmartTable(s.oSmartTable);}};f();g();var i=C.getOwnerComponent();C.byId("template::FilterText").attachBrowserEvent("click",function(){C.byId("page").setHeaderExpanded(true);});var m=i.getModel("_templPriv");m.setProperty("/listReport/isHeaderExpanded",true);m.setProperty("/listReport/deleteEnabled",false);var n=s.oSmartTable.getTable();var r="sapUiSizeCozy",u="sapUiSizeCompact",w="sapUiSizeCondensed";if(n instanceof U||n instanceof d){var V=C.getView();var x=q(document.body);if(x.hasClass(r)||V.hasStyleClass(r)){s.oSmartTable.addStyleClass(r);}else if(x.hasClass(u)||V.hasStyleClass(u)){var y=i.getComponentContainer().getSettings().condensedTableLayout;if(y===true){s.oSmartTable.addStyleClass(w);}else{s.oSmartTable.addStyleClass(u);}}}},handlers:{onBack:function(){t.oCommonUtils.processDataLossConfirmationIfNonDraft(function(){t.oServices.oNavigationController.navigateBack();},q.noop,s);},addEntry:function(i){var m=i.getSource();t.oCommonUtils.processDataLossConfirmationIfNonDraft(function(){t.oCommonEventHandlers.addEntry(m,false,s.oSmartFilterbar);},q.noop,s);},deleteEntries:function(i){t.oCommonEventHandlers.deleteEntries(i);},onSelectionChange:function(m){var n=m.getSource(),r=n.getModel(),P=n.getModel("_templPriv");var u=r.getMetaModel(),w=u.getODataEntitySet(this.getOwnerComponent().getEntitySet()),D=w["Org.OData.Capabilities.V1.DeleteRestrictions"];var x=false;if(sap.suite.ui.generic.template.js.AnnotationHelper.areDeleteRestrictionsValid(u,w.entityType,D)){var y=(D&&D.Deletable&&D.Deletable.Path)?D.Deletable.Path:"";var z=true;var G=(y&&y!=="");var H=t.oCommonUtils.getSelectedContexts(n);if(H.length>0){for(var i=0;i<H.length;i++){var K=r.getObject(H[i].getPath());if(!(K.IsActiveEntity&&K.HasDraftEntity&&K.DraftAdministrativeData&&K.DraftAdministrativeData.InProcessByUser)){z=false;}if(G){if(r.getProperty(y,H[i])){G=false;}}if(!z&&!G){x=true;break;}}}}P.setProperty("/listReport/deleteEnabled",x);t.oCommonUtils.setEnabledToolbarButtons(n);t.oCommonUtils.setEnabledFooterButtons(n,this);},onChange:function(i){t.oCommonEventHandlers.onChange(i);},onSmartFieldUrlPressed:function(i){t.oCommonEventHandlers.onSmartFieldUrlPressed(i,s);},onBreadCrumbUrlPressed:function(i){t.oCommonEventHandlers.onBreadCrumbUrlPressed(i,s);},onContactDetails:function(i){t.oCommonEventHandlers.onContactDetails(i);},onSmartFilterBarInitialise:h,onSmartFilterBarInitialized:j,onBeforeSFBVariantSave:function(){o.onBeforeSFBVariantSave();},onAfterSFBVariantSave:function(){o.onAfterSFBVariantSave();},onDataReceived:function(i){t.oCommonEventHandlers.onDataReceived(i);},onAfterSFBVariantLoad:function(i){o.onAfterSFBVariantLoad(i);},onBeforeRebindTable:function(i){t.oCommonEventHandlers.onBeforeRebindTable(i);C.onBeforeRebindTableExtension(i);t.oCommonEventHandlers.onBeforeRebindTableFinally(i);},onShowDetails:function(i){t.oCommonEventHandlers.onShowDetails(i.getSource(),s);},onListNavigate:function(i){if(!C.onListNavigationExtension(i)){t.oCommonEventHandlers.onListNavigate(i.getSource(),s);}},onCallActionFromToolBar:function(i){t.oCommonEventHandlers.onCallActionFromToolBar(i,s);},onDataFieldForIntentBasedNavigation:function(i){t.oCommonEventHandlers.onDataFieldForIntentBasedNavigation(i,s);},onDataFieldWithIntentBasedNavigation:function(i){t.oCommonEventHandlers.onDataFieldWithIntentBasedNavigation(i,s);},onBeforeSemanticObjectLinkPopoverOpens:function(i){var m=i.getParameters();t.oCommonUtils.processDataLossConfirmationIfNonDraft(function(){var n=s.oSmartFilterbar.getDataSuiteFormat();t.oCommonUtils.semanticObjectLinkNavigation(m,n,C);},q.noop,s,q.noop);},onSemanticObjectLinkNavigationTargetObtained:l,onDraftLinkPressed:function(i){var m=i.getSource();var n=m.getBindingContext();t.oCommonUtils.showDraftPopover(n,m);},onAssignedFiltersChanged:function(i){if(i.getSource()){C.byId("template::FilterText").setText(i.getSource().retrieveFiltersWithValuesAsText());}},onFilterChange:k,onToggleFiltersPressed:function(){var i=C.getOwnerComponent();var m=i.getModel("_templPriv");m.setProperty("/listReport/isHeaderExpanded",!m.getProperty("/listReport/isHeaderExpanded"));},onSearchButtonPressed:function(){var m=C.getOwnerComponent().getModel();var r=function(i){c.handleError("getCollection",C,t.oServices,i.getParameters());s.oSmartTable.getTable().setBusy(false);c.handleTransientMessages(t.oServices.oApplication.getDialogFragmentForView.bind(null,C.getView()));};o.changeIappState(false,true);m.attachEvent('requestFailed',r);m.attachEventOnce('requestCompleted',function(){m.detachEvent('requestFailed',r);});},onSemanticObjectLinkPopoverLinkPressed:function(i){t.oCommonEventHandlers.onSemanticObjectLinkPopoverLinkPressed(i,s);},onAfterTableVariantSave:function(){o.onAfterTableVariantSave();},onAfterApplyTableVariant:function(){o.onAfterApplyTableVariant();},onShareListReportActionButtonPress:function(i){var m=t.oCommonUtils.getDialogFragment("sap.suite.ui.generic.template.ListReport.view.fragments.ShareSheet",{shareEmailPressed:function(){sap.m.URLHelper.triggerEmail(null,t.oCommonUtils.getText("EMAIL_HEADER",[t.oCommonUtils.getText("PAGEHEADER")]),document.URL);},shareJamPressed:function(){var u=sap.ui.getCore().createComponent({name:"sap.collaboration.components.fiori.sharing.dialog",settings:{object:{id:document.URL,share:t.oCommonUtils.getText("PAGEHEADER")}}});u.open();}},"share",function(u,w){var R=sap.ui.getCore().getLibraryResourceBundle("sap.m");w.setProperty("/emailButtonText",R.getText("SEMANTIC_CONTROL_SEND_EMAIL"));w.setProperty("/jamButtonText",R.getText("SEMANTIC_CONTROL_SHARE_IN_JAM"));w.setProperty("/bookmarkButtonText",R.getText("SEMANTIC_CONTROL_SAVE_AS_TILE"));var G=q.sap.getObject("sap.ushell.Container.getUser");w.setProperty("/jamVisible",!!G&&G().isJamActive());});m.openBy(i.getSource());var n=this.getView().byId("template::Share");var r=this.getView().byId("bookmarkButton");r.setBeforePressHandler(function(){n.focus();});},onInlineDataFieldForAction:function(i){var m=i.getSource();var n=t.oCommonUtils.getElementCustomData(m);var r=t.oCommonUtils.getOwnerControl(m);var u=r.getParent().getTableBindingPath();var w=[m.getBindingContext()];t.oCommonUtils.triggerAction(w,u,n,r,s);},onInlineDataFieldForIntentBasedNavigation:function(i){t.oCommonEventHandlers.onInlineDataFieldForIntentBasedNavigation(i.getSource(),s);},onDeterminingDataFieldForAction:function(i){var m=s.oSmartTable.getTable();var n=t.oCommonUtils.getSelectedContexts(m);if(n.length===0){M.error(t.oCommonUtils.getText("ST_GENERIC_NO_ITEM_SELECTED"),{styleClass:t.oCommonUtils.getContentDensityClass()});}else{var r=i.getSource();var u=t.oCommonUtils.getElementCustomData(r);var w=s.oSmartTable.getTableBindingPath();t.oCommonUtils.triggerAction(n,w,u,m);}},onDeterminingDataFieldForIntentBasedNavigation:function(i){var m=i.getSource();var n=t.oCommonUtils.getElementCustomData(m);var r=s.oSmartTable.getTable();var u=t.oCommonUtils.getSelectedContexts(r);var R=!(n.RequiresContext&&n.RequiresContext==="false");if(R&&u.length===0){M.error(t.oCommonUtils.getText("ST_GENERIC_NO_ITEM_SELECTED"),{styleClass:t.oCommonUtils.getContentDensityClass()});}else if(R&&u.length>1){M.error(t.oCommonUtils.getText("ST_GENERIC_MULTIPLE_ITEMS_SELECTED"),{styleClass:t.oCommonUtils.getContentDensityClass()});}else{var w=R?u[0]:null;t.oCommonEventHandlers.onDataFieldForIntentBasedNavigationSelectedContext(w,n,s);}},onIconTabBarSelect:function(i){var K=i.getSource().getSelectedKey();var m,n;m=s.oSmartTable;n=C.byId("listReport-"+K);if(n){s.oSmartTable=n;m.setVisible(false);s.oSmartTable.setVisible(true);s.oSmartTable.rebindTable();t.oCommonUtils.refreshSmartTable(s.oSmartTable);}},onTableInit:function(i){var m=i.getSource();var n=C.getOwnerComponent().getModel("_templPriv");t.oCommonUtils.checkToolbarIntentsSupported(m,n);}},formatters:{formatDraftType:function(D,i,H){if(D&&D.DraftUUID){if(!i){return sap.m.ObjectMarkerType.Draft;}else if(H){return D.InProcessByUser?sap.m.ObjectMarkerType.Locked:sap.m.ObjectMarkerType.Unsaved;}}return sap.m.ObjectMarkerType.Flagged;},formatDraftVisibility:function(D,i){if(D&&D.DraftUUID){if(!i){return sap.m.ObjectMarkerVisibility.TextOnly;}}return sap.m.ObjectMarkerVisibility.IconAndText;},formatDraftLineItemVisible:function(D){if(D&&D.DraftUUID){return true;}return false;},formatDraftOwner:function(D,H){var i="";if(D&&D.DraftUUID&&H){var u=D.InProcessByUserDescription||D.InProcessByUser||D.LastChangedByUserDescription||D.LastChangedByUser;if(u){i=t.oCommonUtils.getText("ST_DRAFT_OWNER",[u]);}else{i=t.oCommonUtils.getText("ST_DRAFT_ANOTHER_USER");}}return i;}},extensionAPI:new E(t,C,s)};}};});
