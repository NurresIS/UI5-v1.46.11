sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/ui/generic/app/navigation/service/SelectionVariant"],function(q,B,S){"use strict";var d="sap.suite.ui.generic.template.customData",a="sap.suite.ui.generic.template.genericData";var I=["INIT","DATA_SUITE","CANCEL","RESET","SET_VM_ID"];function n(o){if(o){for(var p in o){o[p]=null;}}}function N(o,O){var k=Object.keys(o);if(k.length!==Object.keys(O).length){return true;}for(var i=0;i<k.length;i++){var K=k[i];var p=o[K];var P=O[K];if(p.length!==P.length){return true;}for(var j=0;j<p.length;j++){if(p[j]!==P[j]){return true;}}}return false;}function g(s,c,o){var b=c.getOwnerComponent().getSmartVariantManagement();var e=Promise.resolve({appStateKey:"",urlParams:{},selectionVariant:"",tableVariantId:""});var D=false;var O=0;var f=0;var A=false;var E=c.byId("editStateFilter");var h;s.oSmartFilterbar.setSuppressSelection(true);var j=(function(){var i;return function(){i=i||s.oSmartFilterbar.getNonVisibleCustomFilterNames();return i;};})();function k(){return D;}function l(){var M={};M[d]={};var V=[];var Q=j();for(var i=0;i<Q.length;i++){var T=Q[i];if(s.oSmartFilterbar.isVisibleInFilterBarByName(T)){V.push(T);}}M[a]={suppressDataSelection:!D,visibleCustomFields:V};if(E){M[a].editStateFilter=E.getSelectedKey();}c.getCustomAppStateDataExtension(M[d]);return M;}function m(){var M=s.oSmartFilterbar.getDataSuiteFormat();var Q=new S(M);var V=c.getVisibleSelectionsWithDefaults();for(var i=0;i<V.length;i++){if(!Q.getValue(V[i])){Q.addSelectOption(V[i],"I","EQ","");}}var T={selectionVariant:Q.toJSONString(),tableVariantId:(!b&&s.oSmartTable.getCurrentVariantId())||"",customData:l()};return T;}function r(){f--;}function p(){if(!A){return;}A=false;f++;var i;try{i=o.storeInnerAppState(m());}catch(M){q.sap.log.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: "+M);}if(i){i.then(r,r);}else{f--;}}function R(M,Q){if(M&&M.editStateFilter!==undefined){if(E){E.setSelectedKey((M.editStateFilter===null)?0:M.editStateFilter);}}var V=M&&M.visibleCustomFields;if(V&&V.length>0){var T=s.oSmartFilterbar.getAllFilterItems();for(var i=0;i<T.length;i++){var U=T[i];var W=U.getName();if(V.indexOf(W)!==-1){U.setVisibleInFilterBar(true);}}}D=Q&&!(M&&M.suppressDataSelection);if(D){s.oSmartFilterbar.search();}}function t(i){c.restoreCustomAppStateDataExtension(i||{});}function u(i,M){i=i||{};if(i.hasOwnProperty(d)&&i.hasOwnProperty(a)){t(i[d]);R(i[a],M);}else{if(i._editStateFilter!==undefined){R({editStateFilter:i._editStateFilter});delete i._editStateFilter;}t(i);}}function v(){return e.then(function(i){if(i.appStateKey){return{"sap-iapp-state":[i.appStateKey]};}return i.urlParams;});}function w(i,M){if(O===0&&(i||M!==D)){D=M;if(!A){A=true;if(!s.oSmartFilterbar.isDialogOpen()){setTimeout(p,0);}}}}function x(M,Q,T,U,V){s.oSmartFilterbar.setSuppressSelection(false);var W=T.appStateKey||"";var X=T.selectionVariant||"";var Y=(!b&&T.tableVariantId)||"";var Z=(!W&&U)||{};if((M.appStateKey!==W||M.selectionVariant!==X||M.tableVariantId!==Y||N(M.urlParams,Z))&&V!==sap.ui.generic.app.navigation.service.NavType.initial){if(f===0){var $=T&&T.bNavSelVarHasDefaultsOnly;if(T.oSelectionVariant&&M.selectionVariant!==X){var _=T.oSelectionVariant.getParameterNames().concat(T.oSelectionVariant.getSelectOptionsPropertyNames());for(var i=0;i<_.length;i++){s.oSmartFilterbar.addFieldToAdvancedArea(_[i]);}}if($&&s.oSmartFilterbar.isCurrentVariantStandard()){s.oSmartFilterbar.setDataSuiteFormat(X);}else if(!$||s.oSmartFilterbar.isCurrentVariantStandard()){s.oSmartFilterbar.clearVariantSelection();s.oSmartFilterbar.clear();s.oSmartFilterbar.setDataSuiteFormat(X,true);}if(Y!==M.tableVariantId){s.oSmartTable.setCurrentVariantId(Y);}u(T.customData,true);}e=Promise.resolve({appStateKey:W,urlParams:Z,selectionVariant:X,tableVariantId:Y});}if(V!==sap.ui.generic.app.navigation.service.NavType.iAppState){var a1=(V===sap.ui.generic.app.navigation.service.NavType.xAppState&&!T.bNavSelVarHasDefaultsOnly)||(V===sap.ui.generic.app.navigation.service.NavType.URLParams&&!U.bNavSelVarHasDefaultsOnly);D=a1||h||s.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled();if(D){s.oSmartFilterbar.search();}}Q();}function y(i,M,U,Q){var T=e;T.then(function(V){if(T!==e){y(i,M,U,Q);return;}x(V,i,M,U,Q);});}function z(){O--;}function P(){O++;var i=new Promise(function(M,Q){var T=o.parseNavigation();T.done(y.bind(null,M));T.fail(Q);});i.then(z,z);return i;}function C(i){var M=m();s.oSmartFilterbar.setFilterData({_CUSTOM:M.customData});}function F(){w(true,D);}function G(i){var M=i.getParameter("context");var Q=s.oSmartFilterbar.getFilterData();if(Q._CUSTOM!==undefined){u(Q._CUSTOM);}else{var T=l();n(T[d]);n(T[a]);u(T);}if(I.indexOf(M)<0){D=i.getParameter("executeOnSelect");w(true,D);}}function H(){if(!b){w(true,D);}}function J(){if(!b){w(true,D);}}function K(){if(f>0){P();return true;}return false;}function L(){h=s.oSmartTable.getEnableAutoBinding();s.oSmartFilterbar.attachFiltersDialogClosed(p);}s.getCurrentAppState=m;return{areDataShownInTable:k,parseUrlAndApplyAppState:P,getUrlParameterInfo:v,changeIappState:w,onSmartFilterBarInitialise:L,onBeforeSFBVariantSave:C,onAfterSFBVariantSave:F,onAfterSFBVariantLoad:G,onAfterTableVariantSave:H,onAfterApplyTableVariant:J,isStateChange:K};}return B.extend("sap.suite.ui.generic.template.lib.IappStateHandler",{constructor:function(s,c,o){q.extend(this,g(s,c,o));}});});
