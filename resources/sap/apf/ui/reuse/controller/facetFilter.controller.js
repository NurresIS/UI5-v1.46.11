/*!
* SAP APF Analysis Path Framework
* 
 * (c) Copyright 2012-2014 SAP SE. All rights reserved
*/
jQuery.sap.require('sap.apf.ui.utils.facetFilterListHandler');jQuery.sap.require('sap.apf.ui.utils.facetFilterListConverter');jQuery.sap.require('sap.apf.ui.utils.facetFilterValueFormatter');(function(){'use strict';var c={};var f={};var s;var F=new sap.apf.ui.utils.FacetFilterListConverter();function _(o,G){var j=o.getModel();var k=new sap.apf.ui.utils.FacetFilterValueFormatter();G.oFormatterArgs.aFilterValues=G.aFilterValues;var l=k.getFormattedFFData(G.oFormatterArgs);var m=F.getFFListDataFromFilterValues(l,G.oFormatterArgs.sSelectProperty);G.oFilterRestrictionPropagationPromiseForValues.done(function(n,N){_(o,{aFilterValues:n,oFilterRestrictionPropagationPromiseForValues:N,oFormatterArgs:G.oFormatterArgs});});j.setSizeLimit(m.length);j.setData(m);j.updateBindings();}function a(o){o.setActive(false);}function b(C){var l=0;C.getView().byId("idAPFFacetFilter").getLists().forEach(function(L){if(L.getActive()){l++;}});return l;}function d(j,o){var k;j.forEach(function(l){l.selected=false;});o.forEach(function(l){for(k=0;k<j.length;k++){if(l==j[k].key){j[k].selected=true;break;}}});return j;}function e(o,C,G){var j=o.getId();var k=o.getModel();var l=k.getData();G.oFilterRestrictionPropagationPromiseForSelectedValues.done(function(n,N){o.removeSelectedKeys();e(o,C,{aSelectedFilterValues:n,oFilterRestrictionPropagationPromiseForSelectedValues:N});});c[j]=G.aSelectedFilterValues;l=d(l,G.aSelectedFilterValues);k.setData(l);k.updateBindings();}function g(C){var D=jQuery.Deferred();var n=0,l=0;l=b(C);h(C);C.getView().byId("idAPFFacetFilter").getLists().forEach(function(o){(f[o.getId()].getFacetFilterListData().then(_.bind(null,o),a.bind(C,o))).then(function(){f[o.getId()].getSelectedFFValues().then(function(G){e(o,C,G);n++;if(n===l){D.resolve();}});});});return D.promise();}function h(C){C.getView().byId("idAPFFacetFilter").removeAllLists();var v=C.getView().getViewData();var j=v.aConfiguredFilters;var o;j.forEach(function(k){o=new sap.m.FacetFilterList({title:v.oCoreApi.getTextNotHtmlEncoded(k.getLabel()),multiSelect:k.isMultiSelection(),key:k.getPropertyName(),growing:false,listClose:C.onListClose.bind(C)});o.bindItems("/",new sap.m.FacetFilterItem({key:'{key}',text:'{text}',selected:'{selected}'}));var m=new sap.ui.model.json.JSONModel([]);o.setModel(m);C.getView().byId("idAPFFacetFilter").addList(o);});i(C);}function i(C){var v=C.getView().getViewData();var j;f={};v.aConfiguredFilters.forEach(function(o,n){j=C.getView().byId("idAPFFacetFilter").getLists()[n].getId();f[j]=new sap.apf.ui.utils.FacetFilterListHandler(v.oCoreApi,v.oUiApi,o,F);});}sap.ui.controller("sap.apf.ui.reuse.controller.facetFilter",{onInit:function(){var C=this;if(sap.ui.Device.system.desktop){C.getView().addStyleClass("sapUiSizeCompact");}s=false;g(C);},onListClose:function(E){var C=this;var o=E.getSource();var S=[],j,k,l,m,n,p,q=0;j=o.getSelectedItems();S=j.map(function(I){return I.getKey();});k=o.getId();l=c[k];if(l!==undefined){m=JSON.stringify(S.sort());n=JSON.stringify(l.sort());p=(m===n);if(!p){c[k]=S;s=true;f[k].setSelectedFFValues(S);q=b(C);if(C.getView().getViewData().aConfiguredFilters.length>q){g(C).done(function(){C.getView().getViewData().oUiApi.selectionChanged(true);});}else{C.getView().getViewData().oUiApi.selectionChanged(true);}}}},onResetPress:function(){var C=this;if(s||C.getView().getViewData().oCoreApi.isDirty()){C.getView().getViewData().oStartFilterHandler.resetVisibleStartFilters();C.getView().getViewData().oUiApi.selectionChanged(true);s=false;}}});}());
