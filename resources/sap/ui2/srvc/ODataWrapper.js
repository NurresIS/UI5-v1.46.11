// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ui2.srvc.ODataWrapper");var r=function(){jQuery.sap.require.apply(this,arguments);};function n(){}sap.ui2.srvc.testPublishAt=sap.ui2.srvc.testPublishAt||function(){};if(typeof OData!=="object"){r("sap.ui.thirdparty.datajs");}function a(d,R){if(sap.ui2.srvc.isArray(d)){d.forEach(function(D){D.reject(R);});}else{d.reject(R);}}sap.ui2.srvc.ODataWrapper=function(b,o,s){var S="saplb",B,C,d,R,t=this;sap.ui2.srvc.testPublishAt(t);function g(){return B;}sap.ui2.srvc.testPublishAt(t);function h(K,H){var i;K=K.toLowerCase();for(i in H){if(Object.prototype.hasOwnProperty.call(H,i)&&i.toLowerCase()===K){return H[i];}}return undefined;}function e(H){var i=sap.ui2.srvc.ODataWrapper["sap-language"],j=sap.ui2.srvc.ODataWrapper["sap-statistics"],w=sap.ui2.srvc.ODataWrapper["sap-client"];H=H||{};if(i){H["sap-language"]=i;}if(j||(j==="false")){H["sap-statistics"]=""+j;}if(w){H["sap-client"]=w;}return H;}function f(H){H=H||{};var i=sap.ui2.srvc.ODataWrapper.oStickySessionConfiguration[b];if(typeof i==="undefined"){return H;}if(i&&i.enabled&&typeof i.value!=="undefined"){H[S]=i.value;}return H;}sap.ui2.srvc.testPublishAt(t);function k(i){var H,j=sap.ui2.srvc.ODataWrapper.oStickySessionConfiguration[b];if(!j||!j.enabled){return;}H=h(S,i);if(typeof H==="undefined"){return;}if(j.value!==H){j.value=H;}}sap.ui2.srvc.testPublishAt(t);function l(H){return h("x-csrf-token",H)||"";}sap.ui2.srvc.testPublishAt(t);function m(i,M,P,j,F,H){var w;j=j||n;F=F||o.getDefaultErrorHandler();t.check(j,F);w={'Accept':"application/json",'Accept-Language':(sap.ui&&sap.ui.getCore().getConfiguration().getLanguage())||"",'X-CSRF-Token':o.getCsrfToken()};e(w);f(w);OData.request({requestUri:i,method:M,data:P,headers:w},function(D,x){k((x||{}).headers);jQuery.sap.log.debug("Received OData response for "+M+' "'+i+'"',null,"sap.ui2.srvc.ODataWrapper");sap.ui2.srvc.call(j.bind(null,D),F);},function(E){function x(){R=false;F.apply(null,arguments);}function y(){R=false;j.apply(null,arguments);}if(!R&&E.response.statusCode===403&&l(E.response.headers).toLowerCase()==="required"){jQuery.sap.log.debug("CSRF token required for "+M+' "'+i+'", refreshing it',JSON.stringify(E.response),"sap.ui2.srvc.ODataWrapper");R=true;o.refreshCsrfToken(m.bind(t,i,M,P,y,x,H),x);}else{t.onError(M,i,F,null,E);}},H);jQuery.sap.log.debug("Sent OData request for "+M+' "'+i+'"',null,"sap.ui2.srvc.ODataWrapper");}sap.ui2.srvc.testPublishAt(t);function p(j){var i=j.indexOf(b);if(i<0){throw new sap.ui2.srvc.Error('Not relative to base URL "'+b+'": '+j,"sap.ui2.srvc.ODataWrapper");}return j.slice(i+b.length);}sap.ui2.srvc.testPublishAt(t);function q(i){if(/^\//.test(i)){throw new sap.ui2.srvc.Error("Not a relative URL: "+i,"sap.ui2.srvc.ODataWrapper");}return b+i;}sap.ui2.srvc.testPublishAt(t);function u(i,j,w){var D,x=q(i),H=f(e());if(B){jQuery.sap.log.debug('Queued OData request for GET "'+i+'"',null,"sap.ui2.srvc.ODataWrapper");B.push({method:"GET",requestUri:i,headers:H});D=(new jQuery.Deferred()).done(j).fail(w);d.push(D);C=false;return;}H["Accept"]="application/json";H["Accept-Language"]=(sap.ui&&sap.ui.getCore().getConfiguration().getLanguage())||"";H["X-CSRF-Token"]="Fetch";OData.read({requestUri:x,headers:H},j,w);jQuery.sap.log.debug('Sent OData request for GET "'+x+'"',null,"sap.ui2.srvc.ODataWrapper");}sap.ui2.srvc.testPublishAt(t);function v(i,M,P,j,F){var D,w={data:P,method:M,requestUri:i,headers:f(e())},x=q(i);if(B){j=j||n;F=F||o.getDefaultErrorHandler();t.check(j,F);jQuery.sap.log.debug("Queued OData request for "+M+' "'+i+'"',null,"sap.ui2.srvc.ODataWrapper");if(!C){B.push({__changeRequests:[]});d.push([]);C=s;}B[B.length-1].__changeRequests.push(w);D=(new jQuery.Deferred()).done(function(y,z){jQuery.sap.log.debug("Received OData response for "+M+' "'+x+'"',null,"sap.ui2.srvc.ODataWrapper");sap.ui2.srvc.call(j.bind(null,y),F);}).fail(t.onError.bind(t,M,x,F,null));d[d.length-1].push(D);return;}m(x,M,P,j,F);}this.isStickySessionEnabled=function(){return(sap.ui2.srvc.ODataWrapper.oStickySessionConfiguration[b]||{}).enabled||false;};this.enableStickySession=function(){sap.ui2.srvc.ODataWrapper.oStickySessionConfiguration[b].enabled=true;};this.check=function(i,F){if(!i){throw new sap.ui2.srvc.Error("Missing success callback","sap.ui2.srvc.ODataWrapper");}if(typeof i!=="function"){throw new sap.ui2.srvc.Error("Success callback is not a function","sap.ui2.srvc.ODataWrapper");}if(!F){throw new sap.ui2.srvc.Error("Missing error callback","sap.ui2.srvc.ODataWrapper");}if(typeof F!=="function"){throw new sap.ui2.srvc.Error("Error callback is not a function","sap.ui2.srvc.ODataWrapper");}};this.create=function(i,P,j,F){v(i,"POST",P,j,F);};this.del=function(E,i,F){var j=E;if(typeof j!=="string"){j=p(E.__metadata.uri);}v(j,"DELETE",null,function(D){if(i){i();}},F);};this.getBaseUrl=function(){return b;};this.getODataService=function(){return o;};this.onError=function(M,i,F,D,E){var P,j="Error ";if(E.response&&E.response.statusCode){j+="("+E.response.statusCode+", "+E.response.statusText+") ";}j+="in OData response for "+M+' "'+i+'": '+E.message;if(E.response&&E.response.body){try{P=JSON.parse(E.response.body).error;if(P){if(P.hasOwnProperty("message")&&P.message.hasOwnProperty("value")){j+="\nDetails: "+P.message.value;}if(E.response.statusCode&&!P.httpStatus){P.httpStatus=E.response.statusCode;}}}catch(w){}}jQuery.sap.log.error(j,JSON.stringify(E.response),"sap.ui2.srvc.ODataWrapper");if(D){D.reject(j,P);}F(j,P);};this.openBatchQueue=function(){if(B){throw new sap.ui2.srvc.Error("Batch queue already open","sap.ui2.srvc.ODataWrapper");}B=[];d=[];C=false;};this.isBatchQueueOpen=function(){return!!B;};this.read=function(i,j,F,w){var D,x=q(i),y;function z(A,E){k(E.headers);o.setCsrfToken(l(E.headers)||o.getCsrfToken());jQuery.sap.log.debug('Received OData response for GET "'+x+'"',null,"sap.ui2.srvc.ODataWrapper");y=h("sap-message",E.headers);if(y){jQuery.sap.log.warning("SAP message for GET "+x,y,"sap.ui2.srvc.ODataWrapper");}if(D){D.resolve(JSON.parse(JSON.stringify(A)),o.getCsrfToken());}sap.ui2.srvc.call(j.bind(null,A),F);}F=F||o.getDefaultErrorHandler();this.check(j,F);if(w){OData.read.$cache=OData.read.$cache||new sap.ui2.srvc.Map();D=OData.read.$cache.get(x);if(D){jQuery.sap.log.debug('Using cached response for GET "'+x+'"',null,"sap.ui2.srvc.ODataWrapper");D.done(function(A,E){o.setCsrfToken(o.getCsrfToken()||E);sap.ui2.srvc.call(j.bind(null,JSON.parse(JSON.stringify(A))),F);}).fail(F);return;}D=new jQuery.Deferred();OData.read.$cache.put(x,D.promise());}u(i,z,this.onError.bind(this,"GET",x,F,D));};this.batch=function(P,i,F){var j=q("$batch");m(j,"POST",P,i,F,OData.batchHandler);};this.submitBatchQueue=function(w,x){var M=d;function y(D){var A=D.__batchResponses.length,E=M.length;if(E!==A){t.onError("POST",q("$batch"),x,null,{message:"Protocol error! Expected "+E+" responses, but received "+A});return;}D.__batchResponses.forEach(function(z,i){var F=M[i];if(z.response){a(F,z);}else if(z.__changeResponses){z.__changeResponses.forEach(function(G,j){F[j].resolve(G.data,G);});}else{F.resolve(z.data,z);}});if(w){sap.ui2.srvc.call(w,o.getDefaultErrorHandler());}}if(!B){throw new sap.ui2.srvc.Error("No open batch queue to submit","sap.ui2.srvc.ODataWrapper");}if(B.length>0){this.batch({__batchRequests:B},y,x);}else if(w){sap.ui2.srvc.call(w,o.getDefaultErrorHandler(),true);}B=undefined;d=undefined;};this.toString=function(V){var i=['sap.ui2.srvc.ODataWrapper({sBaseUrl:"',b,'"'];i.push('})');return i.join('');};this.put=function(i,P,j,F){v(i,"PUT",P,function(D){if(j){j();}},F);};this.update=function(E,i,F){var P={"__metadata":{type:E.__metadata&&E.__metadata.type}},j,w=p(E.__metadata.uri);for(j in E){if(Object.prototype.hasOwnProperty.call(E,j)&&j.indexOf('$')!==0&&typeof E[j]!=="object"){P[j]=E[j];}}this.put(w,P,i,F);};if(!sap.ui2.srvc.Map){r("sap.ui2.srvc.utils");}if(!b||typeof b!=="string"){throw new sap.ui2.srvc.Error("Missing base URL","sap.ui2.srvc.ODataWrapper");}if(!o||typeof o!=="object"){throw new sap.ui2.srvc.Error("Missing OData service facade","sap.ui2.srvc.ODataWrapper");}b=b.replace(/\/$/,"")+"/";if(typeof sap.ui2.srvc.ODataWrapper.oStickySessionConfiguration==="undefined"){jQuery.sap.log.error("sap.ui2.srvc.ODataWrapper.oStickySessionConfiguration is not defined!","the sap.ui2.srvc.ODataWrapper constructor was called before the static property was defined","sap.ui2.srvc.ODataWrapper");}else if(typeof sap.ui2.srvc.ODataWrapper.oStickySessionConfiguration[b]==="undefined"){sap.ui2.srvc.ODataWrapper.oStickySessionConfiguration[b]={enabled:false,value:undefined};}};if(typeof sap.ui2.srvc.ODataWrapper.oStickySessionConfiguration==="undefined"){sap.ui2.srvc.ODataWrapper.oStickySessionConfiguration={};}sap.ui2.srvc.testPublishAt(sap.ui2.srvc.ODataWrapper);function c(w){try{sap.ui2.srvc.ODataWrapper["sap-statistics"]=sap.ui.getCore().getConfiguration().getStatistics();}catch(e){sap.ui2.srvc.ODataWrapper["sap-statistics"]=/sap-statistics=(true|x|X)/.test(w);}}c(window.location.search);sap.ui2.srvc.createODataWrapper=function(b,s,d){function S(){var w=new sap.ui2.srvc.ODataWrapper(b,this,s);r("sap.ui2.srvc.ODataService");sap.ui2.srvc.ODataService.call(this,w,d);return w;}return new S();};}());
