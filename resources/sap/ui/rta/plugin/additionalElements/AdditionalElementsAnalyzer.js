/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(['sap/ui/comp/odata/MetadataAnalyser','sap/ui/comp/smartfield/AnnotationHelper','sap/ui/core/StashedControlSupport','sap/ui/dt/ElementUtil','sap/ui/rta/Utils','sap/ui/model/PropertyBinding','sap/ui/model/CompositeBinding'],function(M,A,S,E,R,P,C){"use strict";var a=new A();function _(I,B){var s=B[I];if(s){if(Array.isArray(s.parts)){s=s.parts[0]?s.parts[0]:undefined;}s=((typeof s.path)==="string")?s.path:s;}return s;}function b(j){if(j&&j.type){if(j.type.toLowerCase().indexOf("edm")!==0){return true;}}return false;}function c(O,j){return O.reduce(function(r,s){var v=s;if(b(s)){v=j.getFieldsByComplexTypeName(s.type).map(function(t){t.bindingPath=s.name+"/"+t.name;t.entityName=s.entityName;t.referencedComplexPropertyName=s.fieldLabel?s.fieldLabel:s.name;return t;});}else{v.bindingPath=s.name;}return r.concat(v);},[]);}function d(O,j){return O.filter(function(r){return r.visible;}).filter(function(r){var F=a.getFieldControlPath(r);if(F){var s=j.getBindingContext().getProperty(F);return s!==0;}return true;});}function e(j){var r=j.getModel();var s=[];if(r){var t=r.getMetadata().getName();if(t==="sap.ui.model.odata.ODataModel"||t==="sap.ui.model.odata.v2.ODataModel"){s=r.getMetaModel().loaded().then(function(){var u=new M(r);var v=R.getBoundEntityType(j,r);var O=u.getFieldsByEntityTypeName(v)||[];O=c(O,u);O=d(O,j);return O;});}}return s;}function f(O){return{selected:false,label:O.renamedLabel?O.renamedLabel:O.fieldLabel,referencedComplexPropertyName:O.referencedComplexPropertyName?O.referencedComplexPropertyName:"",duplicateComplexName:O.duplicateComplexName?O.duplicateComplexName:false,tooltip:O.quickInfo||O.fieldLabel,type:"odata",entityType:O.entityName,name:O.name,bindingPath:O.bindingPath,originalLabel:O.renamedLabel&&O.renamedLabel!==O.fieldLabel?O.fieldLabel:""};}function g(D){var j=D.element;var r=D.action;return{selected:false,label:R.getLabelForElement(j,r.getLabel),tooltip:R.getLabelForElement(j,r.getLabel),referencedComplexPropertyName:j.referencedComplexPropertyName?j.referencedComplexPropertyName:"",duplicateComplexName:j.duplicateComplexName?j.duplicateComplexName:false,bindingPaths:j.bindingPaths,originalLabel:j.renamedLabel&&j.renamedLabel!==j.labelFromOData?j.labelFromOData:"",type:"invisible",element:j};}function h(B,j){var r=[];if(B instanceof C){var s=B.getBindings();s.forEach(function(B){r=r.concat(h(B,j));});}else if(B instanceof P&&B.getModel()===j&&B.isRelative()&&B.getPath()){r.push(B.getPath());}return r;}function i(j,r){var B=[];k(j,r).forEach(function(F){var s=Object.keys(F.getMetadata().getAllProperties());s.forEach(function(t){var u=F.getBinding(t);B=B.concat(h(u,r));});});return B;}function k(j,r){var B=[];if(jQuery.isEmptyObject(j.mBindingInfos)){for(var s in j.getMetadata().getAllAggregations()){B=B.concat(l(s,j,r));}}else{B.push(j);}return B;}function l(s,j,r){var B=[];E.getAggregation(j,s).forEach(function(t){if(t.getMetadata){var u=Object.keys(t.getMetadata().getAllProperties());var v=[];u.forEach(function(x){var y=t.getBinding(x);v=v.concat(h(y,r));});if(v.length>0){B.push(t);}else{for(var w in t.getMetadata().getAllAggregations()){B=B.concat(l(w,t,r));}}}});return B;}function m(j,r){if(r){return E.findAllSiblingsInContainer(j,r);}else{return[j];}}function n(O){O.forEach(function(r,s,O){if(r["duplicateComplexName"]!==true){for(var j=s+1;j<O.length-1;j++){if(r.fieldLabel===O[j].fieldLabel){r["duplicateComplexName"]=true;O[j]["duplicateComplexName"]=true;}}}});return O;}function o(I,O){return O.some(function(D){return D.fieldLabel===I.fieldLabel;});}function p(I,O){return O.some(function(D){if(I.bindingPaths&&I.bindingPaths.indexOf(D.bindingPath)>-1){I.labelFromOData=D.fieldLabel;if(I.fieldLabel!==I.labelFromOData){I.renamedLabel=true;}if(D.referencedComplexPropertyName){I.referencedComplexPropertyName=D.referencedComplexPropertyName;}return true;}else if(I.bindingPaths===undefined||I.bindingPaths.length===0){return true;}});}var q={enhanceInvisibleElements:function(j,r){var s=j.getModel();return Promise.resolve().then(function(){return e(j);}).then(function(O){O=n(O);var t=[];var I=r.elements||[];I.forEach(function(u){var T=u.getMetadata().getName();var v=r.types[T];var w=v.action;u.bindingPaths=i(u,s);u.fieldLabel=R.getLabelForElement(u,w.getLabel);u.duplicateComplexName=o(u,O);var x=true;if(O.length>0){x=p(u,O);}if(x){t.push({element:u,action:w});}});return t;}).then(function(t){return t.map(g);});},getUnboundODataProperties:function(j,r){var s=j.getModel();return Promise.resolve().then(function(){return e(j);}).then(function(O){var t=m(j,r.relevantContainer);var u=t.reduce(function(w,x){return w.concat(l(r.action.aggregation,x,s));},[]);var v={};var V=u.reduce(function(w,x){if(x.mBindingInfos){for(var I in x.mBindingInfos){var y=_(I,x.mBindingInfos);if(y){w[y]=true;v[y]=R.getLabelForElement(x,r.action.getLabel);}}}return w;},{});var F=r.action.filter?r.action.filter:function(){return true;};O=O.reduce(function(O,D){D["renamedLabel"]=v[D.bindingPath];if(!V[D.bindingPath]&&F(j,D)){return O.concat(D);}else{return O;}},[]);O=n(O);return O;}).then(function(u){return u.map(f);});}};return q;});
