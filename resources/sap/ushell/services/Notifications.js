// @copyright@
sap.ui.define(["sap/ui/thirdparty/datajs","sap/ui/core/ws/SapPcpWebSocket"],function(d,S){"use strict";function N(c,p,s){var m=new sap.ui.model.json.JSONModel(),t=new Date(),o=s&&s.config,r={getNotifications:{},getNotificationsByType:{},getNotificationsInGroup:{},getBadgeNumber:{},resetBadgeNumber:{},getNotificationTypesSettings:{},getNotificationsGroupHeaders:{},getMobileSupportSettings:{},getWebSocketValidity:{},getNotificationCount:{}},w,W=o.webSocketUrl||"/sap/bc/apc/iwngw/notification_push_apc",P=o.pollingIntervalInSeconds||60,u=[],U=[],a=[],i=false,C=[],I=false,O=false,E=true,h,D,b=5000,f=6000,g=false,j={NOTIFICATIONS:0,NOTIFICATIONS_BY_TYPE:1,GET_BADGE_NUMBER:2,RESET_BADGE_NUMBER:3,GET_SETTINGS:4,GET_MOBILE_SUPPORT_SETTINGS:5,NOTIFICATIONS_GROUP_HEADERS:6,NOTIFICATIONS_IN_GROUP:7,GET_NOTIFICATIONS_COUNT:8,VALIDATE_WEBSOCKET_CHANNEL:9,NOTIFICATIONS_BY_DATE_DESCENDING:"notificationsByDateDescending",NOTIFICATIONS_BY_DATE_ASCENDING:"notificationsByDateAscending",NOTIFICATIONS_BY_PRIORITY_DESCENDING:"notificationsByPriorityDescending",NOTIFICATIONS_BY_TYPE_DESCENDING:"notificationsByTypeDescending"},M={PACKAGED_APP:0,FIORI_CLIENT:1,WEB_SOCKET:2,POLLING:3},k,F=false,l,n=true,q=false,H=true,v=false,z=new jQuery.Deferred(),A=new jQuery.Deferred(),B,G=z.promise(),J=false,K=300,L={},Q=10,R=false,T=false;this.isEnabled=function(){if(!o.enabled||!o.serviceUrl){E=false;if(o.enabled&&!o.serviceUrl){jQuery.sap.log.warning("No serviceUrl was found in the service configuration");}}else{E=true;}return E;};this.init=function(){if((!I)&&(this.isEnabled())){this.lastNotificationDate=new Date();n=o.enableNotificationsPreview;this._setWorkingMode();I=true;this.bUpdateDependencyInitiatorExists=false;this._userSettingInitialization();}};this.getUnseenNotificationsCount=function(){var e=jQuery.Deferred();e.resolve(m.getProperty("/UnseenCount"));return e.promise();};this.getNotificationsCount=function(){return m.getProperty("/NotificationsCount")?m.getProperty("/NotificationsCount"):"0";};this.getNotificationsByTypeWithGroupHeaders=function(){var e,x,y=new jQuery.Deferred(),V=this._getRequestURI(j.NOTIFICATIONS_BY_TYPE);x={requestUri:V};if(!this._getHeaderXcsrfToken()){e={};e["X-CSRF-Token"]="fetch";x.headers=e;}OData.request(x,function(X){y.resolve(X);},function(X){if(X.response&&X.response.statusCode===200&&X.response.body){y.resolve(X.response.body);}else{y.reject(X);jQuery.sap.log.error("Notification service - oData for getNotificationsByTypeWithGroupHeaders failed: ",X,"sap.ushell.services.Notifications");}});return y.promise();};this.getNotificationsGroupHeaders=function(){var e,x,y=new jQuery.Deferred(),V=this._getRequestURI(j.NOTIFICATIONS_GROUP_HEADERS);x={requestUri:V};if(!this._getHeaderXcsrfToken()){e={};e["X-CSRF-Token"]="fetch";x.headers=e;}OData.request(x,function(X){y.resolve(X);},function(X){if(X.response&&X.response.statusCode===200&&X.response.body){y.resolve(X.response.body);}else{y.reject();jQuery.sap.log.error("Notification service - oData executeAction failed: ",X,"sap.ushell.services.Notifications");}});return y.promise();};this.getNotificationsBufferInGroup=function(e,x,y){var V=this,X,Y,Z=new jQuery.Deferred(),$={group:e,skip:x,top:y},_,a1,b1=this._getRequestURI(j.NOTIFICATIONS_IN_GROUP,$);if(J===true){_=L[j.NOTIFICATIONS_IN_GROUP].slice(x,x+y);a1=JSON.stringify({"@odata.context":"$metadata#Notifications","value":_});setTimeout(function(){Z.resolve(a1);},1000);}else{Y={requestUri:b1};if(!this._getHeaderXcsrfToken()){X={};X["X-CSRF-Token"]="fetch";Y.headers=X;}OData.request(Y,function(c1){V._updateCSRF(c1.response);Z.resolve(c1.value);},function(c1){if(c1.response&&c1.response.statusCode===200&&c1.response.body){V._updateCSRF(c1.response);Z.resolve(JSON.parse(c1.response.body).value);}else{Z.reject();jQuery.sap.log.error("Notification service - oData executeAction failed: ",c1,"sap.ushell.services.Notifications");}});}return Z.promise();};this.getNotificationsBufferBySortingType=function(e,x,y){var V=this,X,Y,Z=new jQuery.Deferred(),$={skip:x,top:y},_,a1,b1=this._getRequestURI(e,$);if(J===true){_=L[e].slice(x,x+y);a1=JSON.stringify({"@odata.context":"$metadata#Notifications","value":_});setTimeout(function(){Z.resolve(a1);},1000);}else{Y={requestUri:b1};if(!this._getHeaderXcsrfToken()){X={};X["X-CSRF-Token"]="fetch";Y.headers=X;}OData.request(Y,function(c1){V._updateCSRF(c1.response);Z.resolve(c1.value);},function(c1){if(c1.response&&c1.response.statusCode===200&&c1.response.body){V._updateCSRF(c1.response);Z.resolve(JSON.parse(c1.response.body).value);}else{Z.reject();jQuery.sap.log.error("Notification service - oData executeAction failed: ",c1,"sap.ushell.services.Notifications");}});}return Z.promise();};this.getNotifications=function(){var e,x=jQuery.Deferred();if((k===M.FIORI_CLIENT)||(k===M.PACKAGED_APP)){e=this._readNotificationsData(false);e.done(function(){x.resolve(m.getProperty("/Notifications"));}).fail(function(y){x.reject();});}else{x.resolve(m.getProperty("/Notifications"));}return x.promise();};this.executeBulkAction=function(e,x){var y=new jQuery.Deferred(),V=[],X=[],Y={succededNotifications:V,failedNotifications:X},Z=[],$=this;e.forEach(function(_,a1){var b1=new jQuery.Deferred();Z.push(b1.promise());$.executeAction(_,x).done(function(){V.push(_);b1.resolve();}).fail(function(){X.push(_);b1.resolve();});});jQuery.when.apply(jQuery,Z).always(function(){if(X.length){y.reject(Y);}else{y.resolve(Y);}});return y.promise();};this.dismissBulkNotifications=function(e){var x=new jQuery.Deferred(),y=[],V=[],X={succededNotifications:y,failedNotifications:V},Y=[],Z=this;e.forEach(function($,_){var a1=new jQuery.Deferred();Y.push(a1.promise());Z.dismissNotification($).done(function(){y.push($);a1.resolve();}).fail(function(){V.push($);a1.resolve();});});jQuery.when.apply(jQuery,Y).always(function(){if(V.length){x.reject(X);}else{x.resolve(X);}});return x.promise();};this.executeAction=function(e,x){var y=this,V=o.serviceUrl+"/ExecuteAction",X={NotificationId:e,ActionId:x},Y={requestUri:V,method:"POST",data:X,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json","DataServiceVersion":D,"X-CSRF-Token":h}},Z=jQuery.Deferred();OData.request(Y,function($){var _,a1={isSucessfull:true,message:""};if($&&$.response&&$.response.statusCode===200&&$.response.body){_=JSON.parse($.response.body);a1.isSucessfull=_.Success;a1.message=_.MessageText;}Z.resolve(a1);},function($){var _,a1={isSucessfull:false,message:""};if($.response&&$.response.statusCode===200&&$.response.body){_=JSON.parse($.response.body);a1.isSucessfull=_.Success;a1.message=_.MessageText;Z.resolve(a1);}else if(y._csrfTokenInvalid($)&&(R===false)){y._invalidCsrfTokenRecovery(Z,y.executeAction,[e,x]);}else{Z.reject($);jQuery.sap.log.error("Notification service - oData executeAction failed: ",$,"sap.ushell.services.Notifications");}});return Z.promise();};this.markRead=function(e){var x=this,y=o.serviceUrl+"/MarkRead",V={NotificationId:e},X={requestUri:y,method:"POST",data:V,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json","DataServiceVersion":D,"X-CSRF-Token":h}},Y=jQuery.Deferred();OData.request(X,function(Z){Y.resolve();},function(Z){if(x._csrfTokenInvalid(Z)&&(R===false)){x._invalidCsrfTokenRecovery(Y,x.markRead,[e]);}else{jQuery.sap.log.error("Notification service - oData markRead failed: ",Z,"sap.ushell.services.Notifications");Y.reject(Z);}});return Y.promise();};this.dismissNotification=function(e){var x=o.serviceUrl+"/Dismiss",y={NotificationId:e},V={requestUri:x,method:"POST",data:y,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json","DataServiceVersion":D,"X-CSRF-Token":h}},X=jQuery.Deferred();OData.request(V,function(Y){X.resolve();},function(Y){if(that._csrfTokenInvalid(Y)&&(R===false)){that._invalidCsrfTokenRecovery(X,that.dismissNotification,[e]);}else{X.reject(Y);jQuery.sap.log.error("Notification service - oData dismiss notification failed: ",Y,"sap.ushell.services.Notifications");}});return X.promise();};this.registerNotificationsUpdateCallback=function(e){u.push(e);};this.registerDependencyNotificationsUpdateCallback=function(e,x){if(x===false){this.bUpdateDependencyInitiatorExists=true;}U.push({callback:e,dependent:x});};this.registerNotificationCountUpdateCallback=function(e){a.push(e);};this.notificationsSeen=function(){this._setNotificationsAsSeen();};this.isFirstDataLoaded=function(){return F;};this.readSettings=function(){var e;e=this._readSettingsFromServer();return e;};this.saveSettingsEntry=function(e){var x;x=this._writeSettingsEntryToServer(e);return x;};this.getUserSettingsFlags=function(){var e=new jQuery.Deferred();if(v===true){e.resolve({previewNotificationEnabled:q,highPriorityBannerEnabled:H});}else{G.done(function(){e.resolve({previewNotificationEnabled:q,highPriorityBannerEnabled:H});});}return e.promise();};this.setUserSettingsFlags=function(e){q=e.previewNotificationEnabled;H=e.highPriorityBannerEnabled;this._writeUserSettingsFlagsToPersonalization(e);};this._getNotificationSettingsMobileSupport=function(){return B;};this.getPreviewNotificationEnabledConfig=function(){return n;};this.destroy=function(){O=true;if((k===M.WEB_SOCKET)&&w){w.close();}};this._readUnseenNotificationsCount=function(e){var x=this,y=new jQuery.Deferred(),V=this._getRequestURI(j.GET_BADGE_NUMBER),X={requestUri:V};OData.read(X,function(Y,Z){m.setProperty("/UnseenCount",Z.data.GetBadgeNumber.Number);x._setNativeIconBadge(Z.data.GetBadgeNumber.Number);y.resolve(Z.data.GetBadgeNumber.Number);},function(Y){if(Y.response&&Y.response.statusCode===200&&Y.response.body){var Z=JSON.parse(Y.response.body);m.setProperty("/UnseenCount",Z.value);x._setNativeIconBadge(Z.value);y.resolve(Z.value);}else{jQuery.sap.log.error("Notification service - oData read unseen notifications count failed: ",Y.message,"sap.ushell.services.Notifications");y.reject(Y);}});return y.promise();};this.readNotificationsCount=function(){var e=new jQuery.Deferred(),x=this._getRequestURI(j.GET_NOTIFICATIONS_COUNT),y={requestUri:x};OData.read(y,function(V,X){e.resolve(X.data);},function(V){if(V.response&&V.response.statusCode===200&&V.response.body){var X=JSON.parse(V.response.body);e.resolve(X.value);}else{jQuery.sap.log.error("Notification service - oData read notifications count failed: ",V.message,"sap.ushell.services.Notifications");e.reject(V);}});return e.promise();};this._getNotificationSettingsAvalability=function(){return A.promise();};this._setNotificationsAsSeen=function(){var e=this,x=jQuery.Deferred(),y=this._getRequestURI(j.RESET_BADGE_NUMBER),V={requestUri:y,method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json","DataServiceVersion":D,"X-CSRF-Token":h}};if(this._isFioriClientMode()===true||this._isPackagedMode()===true){this._setNativeIconBadge(0);}OData.request(V,function(X,Y){x.resolve();},function(X){if(e._csrfTokenInvalid(X)&&(R===false)){e._invalidCsrfTokenRecovery(x,e._setNotificationsAsSeen);}else{jQuery.sap.log.error("Notification service - oData reset badge number failed: ",X,"sap.ushell.services.Notifications");x.reject(X);}});return x.promise();};this._readNotificationsData=function(e){var x=this,y,V,X,Y=new jQuery.Deferred(),Z=[];y=this._readUnseenNotificationsCount(e);Z.push(y);X=this.readNotificationsCount();X.done(function($){m.setProperty("/NotificationsCount",$);});V=this.getNotificationsBufferBySortingType(j.NOTIFICATIONS_BY_DATE_DESCENDING,0,Q);Z.push(V);jQuery.when.apply(jQuery,Z).then(function($){Z[0].done(function(_){if(e===true){x._updateNotificationsCountConsumers();}});Z[1].done(function(_){m.setProperty("/Notifications",_);x._notificationAlert(_);if(e===true){x._updateNotificationsConsumers();x._updateDependentNotificationsConsumers();}Y.resolve();});});return Y.promise();};this._getHeaderXcsrfToken=function(){return h;};this._getDataServiceVersion=function(){return D;};this._getRequestURI=function(e,x){var y,V=encodeURI(this._getConsumedIntents(e));switch(e){case j.NOTIFICATIONS:if(r.getNotifications.basic===undefined){r.getNotifications.basic=o.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$filter=IsGroupHeader%20eq%20false";}if(this._isIntentBasedConsumption()){if(r.getNotifications.byIntents===undefined){r.getNotifications.byIntents=r.getNotifications.basic.concat("&intents%20eq%20"+V);}return r.getNotifications.byIntents;}return r.getNotifications.basic;case j.NOTIFICATIONS_BY_TYPE:if(r.getNotificationsByType.basic===undefined){r.getNotificationsByType.basic=o.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams";}if(this._isIntentBasedConsumption()){if(r.getNotificationsByType.byIntents===undefined){r.getNotificationsByType.byIntents=r.getNotificationsByType.basic.concat("&$filter=intents%20eq%20"+V);}return r.getNotificationsByType.byIntents;}return r.getNotificationsByType.basic;case j.NOTIFICATIONS_GROUP_HEADERS:if(r.getNotificationsGroupHeaders.basic===undefined){r.getNotificationsGroupHeaders.basic=o.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$filter=IsGroupHeader%20eq%20true";}if(this._isIntentBasedConsumption()){if(r.getNotificationsGroupHeaders.byIntents===undefined){r.getNotificationsGroupHeaders.byIntents=r.getNotificationsGroupHeaders.basic.concat("&intents%20eq%20"+V);}return r.getNotificationsGroupHeaders.byIntents;}return r.getNotificationsGroupHeaders.basic;case j.NOTIFICATIONS_IN_GROUP:if(r.getNotificationsInGroup.basic===undefined){r.getNotificationsInGroup.basic=o.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$orderby=CreatedAt%20desc&$filter=IsGroupHeader%20eq%20false&ParentId%20eq%20"+x.group+"$skip="+x.skip+"&$top="+x.top;}if(this._isIntentBasedConsumption()){if(r.getNotificationsInGroup.byIntents===undefined){r.getNotificationsInGroup.byIntents=r.getNotificationsInGroup.basic.concat("&intents%20eq%20"+V);}return r.getNotificationsInGroup.byIntents;}return r.getNotificationsInGroup.basic;case j.GET_BADGE_NUMBER:if(r.getBadgeNumber.basic===undefined){r.getBadgeNumber.basic=o.serviceUrl+"/GetBadgeNumber()";}if(this._isIntentBasedConsumption()){if(r.getBadgeNumber.byIntents===undefined){r.getBadgeNumber.byIntents=o.serviceUrl+"/GetBadgeCountByIntent("+V+")";}return r.getBadgeNumber.byIntents;}return r.getBadgeNumber.basic;case j.GET_NOTIFICATIONS_COUNT:if(r.getNotificationCount.basic===undefined){r.getNotificationCount.basic=o.serviceUrl+"/Notifications/$count";}return r.getNotificationCount.basic;case j.RESET_BADGE_NUMBER:if(r.resetBadgeNumber.basic===undefined){r.resetBadgeNumber.basic=o.serviceUrl+"/ResetBadgeNumber";}return r.resetBadgeNumber.basic;case j.GET_SETTINGS:if(r.getNotificationTypesSettings.basic===undefined){r.getNotificationTypesSettings.basic=o.serviceUrl+"/NotificationTypePersonalizationSet";}return r.getNotificationTypesSettings.basic;case j.GET_MOBILE_SUPPORT_SETTINGS:if(r.getMobileSupportSettings.basic===undefined){r.getMobileSupportSettings.basic=o.serviceUrl+"/Channels(ChannelId='SAP_SMP')";}return r.getMobileSupportSettings.basic;case j.VALIDATE_WEBSOCKET_CHANNEL:if(r.getWebSocketValidity.basic===undefined){r.getWebSocketValidity.basic=o.serviceUrl+"/Channels('SAP_WEBSOCKET')";}return r.getWebSocketValidity.basic;case j.NOTIFICATIONS_BY_DATE_DESCENDING:y=o.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$orderby=CreatedAt%20desc&$filter=IsGroupHeader%20eq%20false&$skip="+x.skip+"&$top="+x.top;if(this._isIntentBasedConsumption()===true){y=y.concat("&intents%20eq%20"+V);}break;case j.NOTIFICATIONS_BY_DATE_ASCENDING:y=o.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$orderby=CreatedAt%20asc&$filter=IsGroupHeader%20eq%20false&$skip="+x.skip+"&$top="+x.top;if(this._isIntentBasedConsumption()===true){y=y.concat("&intents%20eq%20"+V);}break;case j.NOTIFICATIONS_BY_PRIORITY_DESCENDING:y=o.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$orderby=Priority%20desc&$filter=IsGroupHeader%20eq%20false&$skip="+x.skip+"&$top="+x.top;if(this._isIntentBasedConsumption()===true){y=y.concat("&intents%20eq%20"+V);}break;default:y="";}return y;};this._readSettingsFromServer_noConnection=function(){var e=jQuery.Deferred(),x=[{NotificationTypeId:"type1",NotificationTypeDesc:"aaaaabbbbb-cccccddddd",PriorityDefault:"40-HIGH",DoNotDeliver:false,DoNotDeliverMob:true},{NotificationTypeId:"type2",NotificationTypeDesc:"cccccdddddccc-aaaaabbbbb",PriorityDefault:"10-LOW",DoNotDeliver:true,DoNotDeliverMob:true}];e.resolve(JSON.stringify({"@odata.context":"$metadata#NotificationTypePersonalizationSet","value":x}));return e.promise();};this._readSettingsFromServer_noData=function(){var e=jQuery.Deferred();e.resolve(JSON.stringify({"@odata.context":"$metadata#NotificationTypePersonalizationSet","value":{}}));return e.promise();};this._readSettingsFromServer=function(){var e=this._getRequestURI(j.GET_SETTINGS),x={requestUri:e},y=jQuery.Deferred();OData.request(x,function(V){y.resolve(V.results);},function(V){if(V.response&&V.response.statusCode===200&&V.response.body){y.resolve(V.response.body);}else{y.reject(V);jQuery.sap.log.error("Notification service - oData get settings failed: ",V,"sap.ushell.services.Notifications");}});return y.promise();};this._readMobileSettingsFromServer=function(){var e=this._getRequestURI(j.GET_MOBILE_SUPPORT_SETTINGS),x={requestUri:e},y=jQuery.Deferred(),V,X,Y;OData.request(x,function(Z){if(typeof(Z.results)==="string"){V=JSON.parse(Z.results);V.successStatus=true;X=JSON.stringify(V);y.resolve(X);}else{Z.results.successStatus=true;y.resolve(Z.results);}},function(Z){if(Z.response&&Z.response.statusCode===200&&Z.response.body){V=JSON.parse(Z.response.body);V.successStatus=true;X=JSON.stringify(V);y.resolve(X);}else{y.resolve(JSON.stringify({successStatus:false}));jQuery.sap.log.error("Notification service - oData get settings failed: ",Z,"sap.ushell.services.Notifications");}});return y.promise();};this._checkWebSocketActivity=function(){var e=this._getRequestURI(j.VALIDATE_WEBSOCKET_CHANNEL),x={requestUri:e},y=jQuery.Deferred(),V;OData.request(x,function(X){if(typeof(X.results)==="string"){V=JSON.parse(X.results);y.resolve(V.IsActive);}else{y.resolve(false);}},function(X){if(X.response&&X.response.statusCode===200&&X.response.body){V=JSON.parse(X.response.body);y.resolve(V.IsActive);}else{y.resolve(false);jQuery.sap.log.error("Notification service - oData get settings failed: ",X,"sap.ushell.services.Notifications");}});return y.promise();};this._writeSettingsEntryToServer=function(e){var x=this,y,V=this._getRequestURI(j.GET_SETTINGS)+"(NotificationTypeId="+e.NotificationTypeId+")",X={requestUri:V,method:"PUT",data:{"@odata.context":"$metadata#NotificationTypePersonalizationSet/$entity","NotificationTypeId":e.NotificationTypeId,"NotificationTypeDesc":e.NotificationTypeDesc,"PriorityDefault":e.PriorityDefault,"DoNotDeliver":e.DoNotDeliver,"DoNotDeliverMob":e.DoNotDeliverMob},headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json","DataServiceVersion":D,"X-CSRF-Token":h}};y=jQuery.Deferred();OData.request(X,function(Y){y.resolve(Y);},function(Y){if(Y.response&&Y.response.statusCode===200&&Y.response.body){y.resolve(Y.response.body);}else if(x._csrfTokenInvalid(Y)&&(R===false)){x._invalidCsrfTokenRecovery(y,x._writeSettingsEntryToServer,[e]);}else{y.reject(Y);jQuery.sap.log.error("Notification service - oData set settings entry failed: ",Y,"sap.ushell.services.Notifications");}});return y.promise();};this._updateNotificationsConsumers=function(){u.forEach(function(e){e();});};this._updateDependentNotificationsConsumers=function(){var e=this,x=new jQuery.Deferred();U.forEach(function(y){if(e.bUpdateDependencyInitiatorExists===false){y.callback();}else{y.dependent===true?y.callback(x.promise()):y.callback(x);}});};this._updateNotificationsCountConsumers=function(){a.forEach(function(e){e();});};this._updateAllConsumers=function(){this._updateNotificationsConsumers();this._updateNotificationsCountConsumers();this._updateDependentNotificationsConsumers();};this._getModel=function(){return m;};this._revalidateCsrfToken=function(){var e;h=undefined;T=false;e=this.getNotificationsBufferBySortingType(j.NOTIFICATIONS_BY_DATE_DESCENDING,0,1);return e.promise();};this._csrfTokenInvalid=function(e){return(e.response&&(e.response.statusCode===403)&&(e.response.headers["x-csrf-token"]==="Required"));};this._invalidCsrfTokenRecovery=function(x,y,V){var X=this,Y=this._revalidateCsrfToken(),Z;R=true;Y.done(function(){Z=y.apply(X,V);Z.done(function(e){R=false;x.resolve(e);});Z.fail(function(e){R=false;if(e.response&&e.response.statusCode===200&&e.response.body){x.resolve(e.response.body);}else{x.reject(e);}});});Y.fail(function(e){R=false;x.reject(e);jQuery.sap.log.error("Notification service - oData markRead failed: ",e.message,"sap.ushell.services.Notifications");});};this._getMode=function(){return k;};this._setWorkingMode=function(){var e;if(o.intentBasedConsumption===true){C=this._getIntentsFromConfiguration(o.consumedIntents);if(C.length>0){i=true;}}if(this._isPackagedMode()){k=M.PACKAGED_APP;e=this._getIntentsFromConfiguration(window.fiori_client_appConfig.applications);if(e.length>0){C=e;}if(C.length>0){i=true;}this._registerForPush();this._readNotificationsData(true);this._setNativeIconBadgeWithDelay();return;}this._performFirstRead();};this._performFirstRead=function(){var e=this,x,y=this._readNotificationsData(true);y.done(function(){x=e._getFioriClientRemainingDelay();if(x<=0){e._fioriClientStep();}else{setTimeout(function(){e._fioriClientStep();},x);}F=true;}).fail(function(V){jQuery.sap.log.error("Notifications oData read failed. Error: "+V);return;});};this._fioriClientStep=function(){var e=this,x;if(this._isFioriClientMode()){k=M.FIORI_CLIENT;this._addPushNotificationHandler();x=this.getUnseenNotificationsCount();x.done(function(y){e._setNativeIconBadge(y,function(){});}).fail(function(){});}else{this._webSocketStep();}};this._webSocketStep=function(){k=M.WEB_SOCKET;this._establishWebSocketConnection();};this._webSocketRecoveryStep=function(){if(g===false){g=true;setTimeout(function(){this._webSocketStep();}.bind(this),b);}else{this._activatePollingAfterInterval();}};this._activatePollingAfterInterval=function(){var e=this;setTimeout(function(){e._activatePolling();},P*1000);};this._activatePolling=function(){var e=this;k=M.POLLING;this._readNotificationsData(true);this.timer=setTimeout(e._activatePolling.bind(e,P,false),(P*1000));};this._formatAsDate=function(e){return new Date(e);};this._notificationAlert=function(e){if(H===false){return;}var x,y=[],V=0;for(x in e){if(this.lastNotificationDate&&this._formatAsDate(e[x].CreatedAt)>this.lastNotificationDate){if(e[x].Priority==="HIGH"){y.push(e[x]);}}if(V<this._formatAsDate(e[x].CreatedAt)){V=this._formatAsDate(e[x].CreatedAt);}}if(this.lastNotificationDate&&y&&y.length>0){sap.ui.getCore().getEventBus().publish("sap.ushell.services.Notifications","onNewNotifications",y);}this.lastNotificationDate=V;};this._getFioriClientRemainingDelay=function(){return f-(new Date()-t);};this._establishWebSocketConnection=function(){var x=this,y=false,V;try{w=this._getWebSocketObjectObject(W,[S.SUPPORTED_PROTOCOLS.v10]);w.attachMessage(this,function(X,Y){V=X.getParameter("pcpFields");if((V)&&(V.Command)&&(V.Command==="Notification")){x._readNotificationsData(true);}});w.attachOpen(this,function(X){x._checkWebSocketActivity().done(function(Y){if(!Y){y=true;w.close();x._activatePollingAfterInterval();}});jQuery.sap.log.info("Notifications UShell service WebSocket: webSocket connection opened");});w.attachClose(this,function(X,Y){jQuery.sap.log.warning("Notifications UShell service WebSocket: attachClose called with code: "+X.mParameters.code+" and reason: "+X.mParameters.reason);if((!O)&&(!y)){x._webSocketRecoveryStep();}});w.attachError(this,function(X,Y){jQuery.sap.log.warning("Notifications UShell service WebSocket: attachError called!");});}catch(e){jQuery.sap.log.error("Exception occurred while creating new sap.ui.core.ws.SapPcpWebSocket. Message: "+e.message);}};this._isFioriClientMode=function(){return!(sap.FioriClient===undefined);};this._isPackagedMode=function(){return(window.fiori_client_appConfig&&window.fiori_client_appConfig.prepackaged===true);};this._setNativeIconBadge=function(e){if((sap.Push!==undefined)&&(sap.Push.setBadgeNumber!==undefined)){sap.Push.setBadgeNumber(e,function(){});}};this._setNativeIconBadgeWithDelay=function(){var e=this,x;setTimeout(function(){x=e.getUnseenNotificationsCount();x.done(function(y){e._setNativeIconBadge(y);}).fail(function(){});},4000);};this._getIntentsFromConfiguration=function(e){var x=[],y,V;if(e&&e.length>0){for(V=0;V<e.length;V++){y=e[V].intent;x.push(y);}}return x;};this._handlePushedNotification=function(e){var x,y,V,X,Y=[],Z;if(e!==undefined){if((e.additionalData===undefined)||(e.additionalData.foreground===true)){this._readNotificationsData(true);}else{x=e.NotificationId;y=e.NavigationTargetObject;V=e.NavigationTargetAction;X=e.NavigationTargetParam;if(X){if(typeof X==='string'||X instanceof String){Y[0]=X;}else if(Array.isArray(X)===true){Y=X;}}if((typeof hasher!=="undefined")&&(hasher.getHash()===y+"-"+V)){Z=sap.ui.getCore().byId('viewPortContainer');if(Z){Z.switchState("Center");}}sap.ushell.utils.toExternalWithParameters(y,V,Y);this.markRead(x);this._readNotificationsData(true);}}};this._registerForPush=function(){sap.Push.initPush(this._handlePushedNotification.bind(this));};this._addPushNotificationHandler=function(){document.addEventListener("deviceready",this._registerForPush.bind(this),false);};this._isIntentBasedConsumption=function(){return i;};this._getConsumedIntents=function(e){var x="",y;if(!this._isIntentBasedConsumption()){return x;}if(C.length>0){if(e!==j.GET_BADGE_NUMBER){x="&";}for(y=0;y<C.length;y++){if(e===j.GET_BADGE_NUMBER){if(y===0){x=C[y];}else{x=x+","+C[y];}}else{x=x+"NavigationIntent%20eq%20%27"+C[y]+"%27";}}}return x;};this._notificationsAscendingSortBy=function(e,V){e.sort(function(x,y){var X=x[V],Y=y[V];if(X===Y){X=x.id;Y=y.id;}return Y>X?-1:1;});return e;};this._getWebSocketObjectObject=function(W,V){return new S(W,V);};this._notificationsDescendingSortBy=function(e,V){e.sort(function(x,y){var X=x[V],Y=y[V];if(X===Y){X=x.id;Y=y.id;return X>Y?-1:1;}if(V==="Priority"){if(X==="HIGH"){return-1;}if(Y==="HIGH"){return 1;}if(X==="MEDIUM"){return-1;}return 1;}return X>Y?-1:1;});return e;};this.getOperationEnum=function(){return j;};this._readUserSettingsFlagsFromPersonalization=function(){var e=this,x,y;try{y=this._getUserSettingsPersonalizer().getPersData();}catch(V){jQuery.sap.log.error("Personalization service does not work:");jQuery.sap.log.error(V.name+": "+V.message);x=new jQuery.Deferred();x.reject(V);y=x.promise();}y.done(function(X){if(X===undefined){e._writeUserSettingsFlagsToPersonalization({previewNotificationEnabled:q,highPriorityBannerEnabled:H});}else{q=X.previewNotificationEnabled;H=X.highPriorityBannerEnabled;}v=true;z.resolve();});y.fail(function(){jQuery.sap.log.error("Reading User Settings flags from Personalization service failed");});};this._writeUserSettingsFlagsToPersonalization=function(e){var x,y;try{y=this._getUserSettingsPersonalizer().setPersData(e);}catch(V){jQuery.sap.log.error("Personalization service does not work:");jQuery.sap.log.error(V.name+": "+V.message);x=new jQuery.Deferred();x.reject(V);y=x.promise();}return y;};this._getUserSettingsPersonalizer=function(){if(l===undefined){l=this._createUserSettingsPersonalizer();}return l;};this._createUserSettingsPersonalizer=function(){var e=sap.ushell.Container.getService("Personalization"),x,y={keyCategory:e.constants.keyCategory.FIXED_KEY,writeFrequency:e.constants.writeFrequency.LOW,clientStorageAllowed:true},V={container:"sap.ushell.services.Notifications",item:"userSettingsData"},X=e.getPersonalizer(V,y,x);return X;};this._updateCSRF=function(e){if((T===true)||(e.headers===undefined)){return;}if(!this._getHeaderXcsrfToken()){h=e.headers["x-csrf-token"]||e.headers["X-CSRF-Token"]||e.headers["X-Csrf-Token"];}if(!this._getDataServiceVersion()){D=e.headers.DataServiceVersion||e.headers["odata-version"];}T=true;};this._userSettingInitialization=function(){var e,x,y={settingsAvailable:false,mobileAvailable:false},V,X,Y;this._readUserSettingsFlagsFromPersonalization();e=this._readSettingsFromServer();x=this._readMobileSettingsFromServer();V=[e,x];e.done(function(){y.settingsAvailable=true;});e.fail(function(){q=true;});x.done(function(Z){X=JSON.parse(Z);Y=X.successStatus;if(Y){B=Z?X.IsActive:false;y.mobileAvailable=B;}else{B=false;y.mobileAvailable=false;}});jQuery.when.apply(jQuery,V).then(function(Z){A.resolve(y);});};};N.hasNoAdapter=true;return N;},true);
